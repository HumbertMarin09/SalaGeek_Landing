const CONFIG={TOAST_DURATION:5e3,MIN_IMAGE_SIZE:50,MAX_GRID_COLUMNS:4,DEFAULT_GRID_GAP:8,MAX_EXCERPT_LENGTH:250,EXCERPT_WARNING_LENGTH:150,EXCERPT_DANGER_LENGTH:200,META_DESC_OPTIMAL:160,META_DESC_WARNING:140,MAX_SLUG_LENGTH:60,MAX_HISTORY_SIZE:50,DEBOUNCE_SAVE_STATE:300,RECENT_ARTICLES_LIMIT:5};class SalaGeekAdmin{constructor(){this.user=null,this.articles=[],this.drafts=[],this.categories=[],this.tags=[],this.currentSection="dashboard",this.editingArticle=null,this.contentSaved=!1,this.savedEditorRange=null,this.currentImageSource="url",this.uploadedImageData=null,this.draggedEditorImage=null,this.selectedImage=null,this.gridImages=[],this.gridCols=2,this.gridGap=CONFIG.DEFAULT_GRID_GAP,this.galleryImages=[],this.galleryUploadData=null,this.gallerySelectMode=!1,this.editorHistory=[],this.historyIndex=-1,this.isUndoRedo=!1,this._editorElement=null,this.init()}get editorElement(){return this._editorElement&&document.body.contains(this._editorElement)||(this._editorElement=document.getElementById("article-editor")),this._editorElement}async init(){this.initAuth(),this.setupEventListeners(),this.setupImageModals(),this.setupImageResizeModal(),this.setupGalleryModal(),this.setupSEOPreview(),this.setupCollapsibleSections(),this.setupCategoryMultiSelect(),this.setupEditorImageHandlers(),this.setupForgotPasswordModal(),this.setupResetPasswordModal(),await this.checkSession()}initAuth(){const e=document.getElementById("login-form");e&&e.addEventListener("submit",async e=>{e.preventDefault(),await this.handleLoginSubmit(e)})}async checkSession(){try{const e=await fetch("/api/auth.php?action=check",{credentials:"include"}),t=await e.json();t.authenticated&&t.user&&(this.user=t.user,this.authToken=t.token,this.handleLogin(t.user))}catch(e){}}async handleLoginSubmit(e){const t=e.target,n=t.querySelector("#login-email").value,a=t.querySelector("#login-password").value,i=t.querySelector("#login-btn"),r=i.querySelector(".btn-text"),s=i.querySelector(".btn-loader"),o=document.getElementById("login-error");i.disabled=!0,r.classList.add("hidden"),s.classList.remove("hidden"),o.classList.add("hidden");try{const e=await fetch("/api/auth.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:n,password:a})}),t=await e.json();if(!e.ok||!t.success)throw new Error(t.error||"Error al iniciar sesi√≥n");this.user=t.user,this.authToken=t.token,this.handleLogin(t.user)}catch(e){o.textContent=e.message,o.classList.remove("hidden")}finally{i.disabled=!1,r.classList.remove("hidden"),s.classList.add("hidden")}}handleLogin(e){this.user=e,document.getElementById("login-screen").classList.add("hidden"),document.getElementById("admin-dashboard").classList.remove("hidden");const t=e.name||e.user_metadata?.full_name||e.email.split("@")[0];document.getElementById("user-name").textContent=t,document.getElementById("user-email").textContent=e.email,document.getElementById("user-avatar").textContent=t.charAt(0).toUpperCase(),this.loadArticles(),this.showToast(`¬°Bienvenido, ${t}!`,"success")}async handleLogout(){try{await fetch("/api/auth.php?action=logout",{method:"POST",credentials:"include"})}catch(e){console.error("Error al cerrar sesi√≥n:",e)}this.user=null,this.authToken=null,this.articles=[],document.getElementById("login-screen").classList.remove("hidden"),document.getElementById("admin-dashboard").classList.add("hidden");const e=document.getElementById("login-form");e&&e.reset()}async getAccessToken(){if(!this.user)throw new Error("Sesi√≥n expirada. Por favor, vuelve a iniciar sesi√≥n.");return this.authToken||"session-auth"}async changePassword(){const e=document.getElementById("change-password-modal");e&&(e.classList.remove("hidden"),this.setupChangePasswordModal())}closePasswordModal(){const e=document.getElementById("change-password-modal");if(e){e.classList.add("hidden"),document.getElementById("change-password-form")?.reset(),document.getElementById("password-error")?.classList.add("hidden");const t=document.querySelector(".strength-fill"),n=document.querySelector(".strength-text");t&&(t.className="strength-fill"),n&&(n.className="strength-text",n.textContent="Ingresa una contrase√±a")}}setupChangePasswordModal(){const e=document.getElementById("change-password-form"),t=document.getElementById("new-password"),n=document.getElementById("confirm-new-password"),a=document.querySelector(".strength-fill"),i=document.querySelector(".strength-text"),r=document.getElementById("password-error"),s=document.getElementById("change-password-modal");s.querySelector('[data-close="change-password-modal"]')?.addEventListener("click",()=>{this.closePasswordModal()}),s.addEventListener("click",e=>{e.target===s&&this.closePasswordModal()});document.addEventListener("keydown",e=>{"Escape"!==e.key||s.classList.contains("hidden")||this.closePasswordModal()}),document.querySelectorAll(".toggle-password").forEach(e=>{e.onclick=()=>{const t=e.dataset.target,n=document.getElementById(t),a=e.querySelector(".eye-open"),i=e.querySelector(".eye-closed");"password"===n.type?(n.type="text",a.style.display="none",i.style.display="block"):(n.type="password",a.style.display="block",i.style.display="none")}}),t.oninput=()=>{const e=t.value,n=this.checkPasswordStrength(e);a.className="strength-fill "+n.level,i.className="strength-text "+n.level,i.textContent=n.text},e.onsubmit=async e=>{e.preventDefault();const a=document.getElementById("current-password").value,i=t.value;if(i!==n.value)return r.textContent="Las contrase√±as no coinciden",void r.classList.remove("hidden");if(i.length<8)return r.textContent="La contrase√±a debe tener al menos 8 caracteres",void r.classList.remove("hidden");r.classList.add("hidden");const s=document.getElementById("save-password-btn"),o=s.querySelector("span:not(.btn-loader)"),l=s.querySelector(".btn-loader");o.style.display="none",l.classList.remove("hidden"),s.disabled=!0;try{const e=await fetch("/api/auth.php?action=change-password",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({currentPassword:a,newPassword:i})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Error al cambiar la contrase√±a");this.closePasswordModal(),this.showPasswordChangeSuccess(t.newHash)}catch(e){r.textContent=e.message,r.classList.remove("hidden")}finally{o.style.display="",l.classList.add("hidden"),s.disabled=!1}}}checkPasswordStrength(e){if(!e)return{level:"",text:"Ingresa una contrase√±a"};let t=0;return e.length>=8&&t++,e.length>=12&&t++,/[a-z]/.test(e)&&t++,/[A-Z]/.test(e)&&t++,/[0-9]/.test(e)&&t++,/[^a-zA-Z0-9]/.test(e)&&t++,t<=2?{level:"weak",text:"D√©bil - Agrega m√°s caracteres"}:t<=3?{level:"fair",text:"Regular - Usa may√∫sculas y n√∫meros"}:t<=4?{level:"good",text:"Buena - Agrega s√≠mbolos"}:{level:"strong",text:"Excelente"}}showPasswordChangeSuccess(e){const t=document.getElementById("confirm-modal");if(!t)return void alert("Contrase√±a verificada. Nuevo hash: "+e);const n=t.querySelector(".confirm-icon"),a=t.querySelector("h3"),i=t.querySelector("p"),r=document.getElementById("confirm-accept"),s=document.getElementById("confirm-cancel");n.className="confirm-icon info";const o=n.querySelector(".icon-danger"),l=n.querySelector(".icon-warning"),d=n.querySelector(".icon-info");o&&(o.style.display="none"),l&&(l.style.display="none"),d&&(d.style.display="block"),a.textContent="¬°Contrase√±a verificada!",i.innerHTML=`\n      <p style="margin-bottom: 1rem; text-align: left;">Tu contrase√±a actual fue verificada. Para completar el cambio:</p>\n      <ol style="text-align: left; margin-bottom: 1rem; padding-left: 1.25rem; font-size: 0.85rem;">\n        <li>Ve al panel de Hostinger</li>\n        <li>Sitios ‚Üí Tu sitio ‚Üí Configuraci√≥n avanzada</li>\n        <li>Variables de entorno ‚Üí ADMIN_PASSWORD_HASH</li>\n        <li>Pega el nuevo hash (abajo)</li>\n      </ol>\n      <div style="background: var(--admin-bg); padding: 0.75rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.7rem; word-break: break-all; margin-bottom: 1rem; text-align: left;">\n        ${e}\n      </div>\n      <button type="button" class="btn-secondary" style="width: 100%;" onclick="navigator.clipboard.writeText('${e}'); this.textContent='¬°Copiado!';">\n        üìã Copiar Hash\n      </button>\n    `,r.textContent="Entendido",r.className="btn-primary",s.style.display="none",t.classList.remove("hidden");const c=()=>{t.classList.add("hidden"),s.style.display="",i.innerHTML="",r.removeEventListener("click",c),this.showToast("Recuerda actualizar el hash en Hostinger","info")};r.addEventListener("click",c)}setupForgotPasswordModal(){const e=document.getElementById("forgot-password-link"),t=document.getElementById("forgot-password-modal"),n=document.getElementById("generate-token-btn"),a=document.getElementById("recovery-token-display"),i=document.getElementById("recovery-token-code"),r=document.getElementById("copy-recovery-token");if(!e||!t)return;e.addEventListener("click",e=>{e.preventDefault(),t.classList.remove("hidden"),a.classList.add("hidden"),i.textContent="",n.disabled=!1,n.querySelector("span").textContent="Generar Token"});t.querySelectorAll('[data-close="forgot-password-modal"]').forEach(e=>{e.addEventListener("click",()=>{t.classList.add("hidden")})}),t.addEventListener("click",e=>{e.target===t&&t.classList.add("hidden")}),document.addEventListener("keydown",e=>{"Escape"!==e.key||t.classList.contains("hidden")||t.classList.add("hidden")}),n.addEventListener("click",async()=>{try{n.disabled=!0,n.querySelector("span").textContent="Generando...";const e=await fetch("/api/auth.php?action=forgot-password",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"}),s=await e.json();if(!e.ok)throw new Error(s.error||"Error al generar token");i.textContent=s.token,a.classList.remove("hidden"),n.querySelector("span").textContent="‚úì Token Generado",this.showToast("Token generado exitosamente","success"),r.addEventListener("click",()=>{navigator.clipboard.writeText(s.token);const e=r.innerHTML;r.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ¬°Copiado!',setTimeout(()=>{r.innerHTML=e},2e3)}),setTimeout(()=>{t.classList.add("hidden"),document.getElementById("reset-password-modal").classList.remove("hidden"),document.getElementById("reset-token").value=s.token},2e3)}catch(e){console.error("Error:",e),this.showToast(e.message,"error"),n.disabled=!1,n.querySelector("span").textContent="Generar Token"}})}setupResetPasswordModal(){const e=document.getElementById("reset-password-modal"),t=document.getElementById("reset-password-form"),n=document.getElementById("reset-password-btn"),a=document.getElementById("reset-error"),i=document.getElementById("reset-new-password"),r=document.getElementById("reset-confirm-password"),s=document.getElementById("reset-password-strength");if(!e||!t)return;e.querySelectorAll('[data-close="reset-password-modal"]').forEach(n=>{n.addEventListener("click",()=>{e.classList.add("hidden"),t.reset(),a.classList.add("hidden")})}),e.addEventListener("click",n=>{n.target===e&&(e.classList.add("hidden"),t.reset(),a.classList.add("hidden"))}),document.addEventListener("keydown",n=>{"Escape"!==n.key||e.classList.contains("hidden")||(e.classList.add("hidden"),t.reset(),a.classList.add("hidden"))}),e.querySelectorAll(".toggle-password").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,n=document.getElementById(t),a=e.querySelector(".eye-open"),i=e.querySelector(".eye-closed");"password"===n.type?(n.type="text",a.style.display="none",i.style.display="block"):(n.type="password",a.style.display="block",i.style.display="none")})}),i.addEventListener("input",()=>{const e=this.checkPasswordStrength(i.value),t=s.querySelector(".strength-fill"),n=s.querySelector(".strength-text");t.className="strength-fill "+e.level,n.className="strength-text "+e.level,n.textContent=e.text}),t.addEventListener("submit",async s=>{s.preventDefault(),a.classList.add("hidden");const o=document.getElementById("reset-token").value.trim(),l=i.value,d=r.value;if(!o)return a.textContent="Ingresa el token de recuperaci√≥n",void a.classList.remove("hidden");if(l.length<8)return a.textContent="La contrase√±a debe tener al menos 8 caracteres",void a.classList.remove("hidden");if(l!==d)return a.textContent="Las contrase√±as no coinciden",void a.classList.remove("hidden");try{n.disabled=!0,n.querySelector("span").textContent="Reseteando...";const a=await fetch("/api/auth.php?action=reset-password",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({token:o,newPassword:l})}),i=await a.json();if(!a.ok)throw new Error(i.error||"Error al resetear contrase√±a");e.classList.add("hidden"),t.reset(),this.showToast("Contrase√±a reseteada exitosamente","success"),this.showPasswordChangeSuccess(i.newHash)}catch(e){console.error("Error:",e),a.textContent=e.message,a.classList.remove("hidden")}finally{n.disabled=!1,n.querySelector("span").textContent="Resetear Contrase√±a"}})}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null)}saveEditorState(){const e=document.getElementById("article-editor");if(!e||this.isUndoRedo)return;const t=e.innerHTML;this.historyIndex>=0&&this.editorHistory[this.historyIndex]===t||(this.historyIndex<this.editorHistory.length-1&&(this.editorHistory=this.editorHistory.slice(0,this.historyIndex+1)),this.editorHistory.push(t),this.editorHistory.length>CONFIG.MAX_HISTORY_SIZE?this.editorHistory.shift():this.historyIndex++,this.updateUndoRedoButtons())}undo(){if(this.historyIndex<=0)return void this.showToast("No hay m√°s acciones para deshacer","info");this.isUndoRedo=!0,this.historyIndex--;const e=this.editorElement;e&&(e.innerHTML=this.editorHistory[this.historyIndex],this.setupEditorImages(),this.updateWordCount()),this.isUndoRedo=!1,this.updateUndoRedoButtons()}redo(){if(this.historyIndex>=this.editorHistory.length-1)return void this.showToast("No hay m√°s acciones para rehacer","info");this.isUndoRedo=!0,this.historyIndex++;const e=this.editorElement;e&&(e.innerHTML=this.editorHistory[this.historyIndex],this.setupEditorImages(),this.updateWordCount()),this.isUndoRedo=!1,this.updateUndoRedoButtons()}updateUndoRedoButtons(){const e=document.querySelector('[data-command="undo"]'),t=document.querySelector('[data-command="redo"]');if(e&&(e.classList.toggle("disabled",this.historyIndex<=0),e.title=this.historyIndex>0?`Deshacer (Ctrl+Z) - ${this.historyIndex} acciones disponibles`:"Nada que deshacer"),t){const e=this.editorHistory.length-1-this.historyIndex;t.classList.toggle("disabled",e<=0),t.title=e>0?`Rehacer (Ctrl+Y) - ${e} acciones disponibles`:"Nada que rehacer"}}clearEditorHistory(){this.editorHistory=[],this.historyIndex=-1,this.updateUndoRedoButtons()}setupEventListeners(){document.getElementById("logout-btn")?.addEventListener("click",()=>{this.handleLogout()}),document.getElementById("change-password-btn")?.addEventListener("click",()=>{this.changePassword()}),document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),this.navigateTo(e.dataset.section)})}),document.querySelectorAll("[data-section]").forEach(e=>{e.classList.contains("nav-item")||e.addEventListener("click",t=>{t.preventDefault();const n=e.dataset.section;this.navigateTo(n)})}),document.querySelectorAll("[data-action]").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;this.handleAction(t)})}),document.getElementById("mobile-menu-btn")?.addEventListener("click",()=>{document.querySelector(".admin-sidebar").classList.toggle("open")}),document.getElementById("article-form")?.addEventListener("submit",e=>{e.preventDefault(),"tags-input"!==document.activeElement?.id&&this.saveArticle(!1)}),document.getElementById("btn-draft")?.addEventListener("click",()=>{this.saveArticle(!0)}),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"s"===e.key&&"new-article"===this.currentSection&&(e.preventDefault(),this.saveArticle(!0))}),document.getElementById("article-title")?.addEventListener("input",e=>{const t=this.generateSlug(e.target.value);document.getElementById("article-slug").value=t}),document.getElementById("article-excerpt")?.addEventListener("input",e=>{const t=e.target.value.length,n=document.getElementById("excerpt-count"),a=n.parentElement;n.textContent=t,a.style.color=t>CONFIG.EXCERPT_DANGER_LENGTH?"var(--admin-danger)":t>CONFIG.EXCERPT_WARNING_LENGTH?"var(--admin-warning)":"var(--admin-text-muted)"}),document.getElementById("meta-description")?.addEventListener("input",e=>{const t=e.target.value.length,n=document.getElementById("meta-description-count");if(n){const e=n.parentElement;n.textContent=t,e.style.color=t>CONFIG.META_DESC_OPTIMAL?"var(--admin-danger)":t>CONFIG.META_DESC_WARNING?"var(--admin-warning)":"var(--admin-text-muted)"}});const e=document.getElementById("tags-input");e&&(e.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault(),e.stopPropagation();const t=e.target.value;if(t.trim()){t.split(",").map(e=>e.trim()).filter(e=>e.length>0).forEach(e=>this.addTag(e)),e.target.value=""}}else if(","===e.key){e.preventDefault();const t=e.target.value;t.trim()&&(this.addTag(t.trim()),e.target.value="")}}),e.addEventListener("blur",e=>{const t=e.target.value.trim();if(t){t.split(",").map(e=>e.trim()).filter(e=>e.length>0).forEach(e=>this.addTag(e)),e.target.value=""}})),this.setupImageUpload(),this.setupEditorToolbar(),document.getElementById("btn-preview")?.addEventListener("click",()=>{this.showPreview()}),document.getElementById("close-preview")?.addEventListener("click",()=>{document.getElementById("preview-modal").classList.add("hidden")}),document.getElementById("search-articles")?.addEventListener("input",e=>{this.filterArticlesTable(e.target.value)}),document.getElementById("filter-category")?.addEventListener("change",()=>{this.filterArticlesTable()});const t=new Date;t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),document.getElementById("article-date").value=t.toISOString().slice(0,16)}setupImageUpload(){const e=document.getElementById("image-upload"),t=document.getElementById("featured-image"),n=document.getElementById("upload-placeholder"),a=document.getElementById("image-preview"),i=document.getElementById("preview-img"),r=document.getElementById("remove-image"),s=document.getElementById("image-url");n?.addEventListener("click",()=>t.click()),e?.addEventListener("dragover",t=>{t.preventDefault(),e.style.borderColor="var(--admin-primary)"}),e?.addEventListener("dragleave",()=>{e.style.borderColor=""}),e?.addEventListener("drop",t=>{t.preventDefault(),e.style.borderColor="";const n=t.dataTransfer.files[0];n&&n.type.startsWith("image/")&&this.handleImageFile(n)}),t?.addEventListener("change",e=>{const t=e.target.files[0];t&&this.handleImageFile(t)}),r?.addEventListener("click",()=>{a.classList.add("hidden"),n.classList.remove("hidden"),t.value="",i.src="",s.value=""}),s?.addEventListener("input",e=>{const t=e.target.value.trim();if(t){(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i.test(t)||/^https?:\/\/.+/i.test(t))&&(i.src=t,i.onerror=()=>{this.showToast("No se pudo cargar la imagen desde esa URL","error"),a.classList.add("hidden"),n.classList.remove("hidden")},i.onload=()=>{a.classList.remove("hidden"),n.classList.add("hidden")})}else a.classList.add("hidden"),n.classList.remove("hidden")})}handleImageFile(e){const t=new FileReader;t.onload=e=>{document.getElementById("preview-img").src=e.target.result,document.getElementById("image-preview").classList.remove("hidden"),document.getElementById("upload-placeholder").classList.add("hidden")},t.readAsDataURL(e)}setupEditorToolbar(){const e=document.getElementById("article-editor");let t;document.querySelectorAll(".editor-toolbar button").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.command;this.executeEditorCommand(t)})}),e?.addEventListener("input",()=>{this.updateWordCount();const n=e.innerText.trim(),a=e.querySelector("img, .resizable-image, figure, .image-grid-container"),i=e.querySelector("iframe, .youtube-embed, .video-container");""!==n&&"\n"!==n||a||i||(e.innerHTML=""),clearTimeout(t),t=setTimeout(()=>{this.saveEditorState()},CONFIG.DEBOUNCE_SAVE_STATE)}),e?.addEventListener("mouseup",()=>{this.updateToolbarState(),setTimeout(()=>this.showFloatingToolbar(),10)}),e?.addEventListener("keyup",e=>{this.updateToolbarState(),e.shiftKey?setTimeout(()=>this.showFloatingToolbar(),10):this.hideFloatingToolbar()}),document.addEventListener("mousedown",e=>{const t=document.getElementById("floating-toolbar");t&&!t.contains(e.target)&&setTimeout(()=>{const e=window.getSelection();e&&!e.isCollapsed||this.hideFloatingToolbar()},200)}),e?.addEventListener("keydown",t=>{if(t.ctrlKey||t.metaKey)switch(t.key.toLowerCase()){case"z":t.preventDefault(),t.shiftKey?this.redo():this.undo();break;case"y":t.preventDefault(),this.redo();break;case"b":t.preventDefault(),this.executeEditorCommand("bold");break;case"i":t.preventDefault(),this.executeEditorCommand("italic");break;case"u":t.preventDefault(),this.executeEditorCommand("underline");break;case"k":t.preventDefault(),this.executeEditorCommand("link")}if("Delete"===t.key||"Backspace"===t.key){const n=e.querySelector("img.selected");n&&(t.preventDefault(),this.deleteSelectedImage(n));const a=e.querySelector(".image-grid-container.selected");a&&(t.preventDefault(),this.deleteSelectedGrid(a));const i=e.querySelector(".video-container.selected, .youtube-embed.selected");i&&(t.preventDefault(),i.remove(),this.showToast("Video eliminado","success"),this.saveEditorState())}}),e?.addEventListener("dragstart",e=>{"IMG"===e.target.tagName&&(e.dataTransfer.setData("text/editor-image","true"),e.dataTransfer.effectAllowed="move",this.draggedEditorImage=e.target,e.target.classList.add("dragging"))}),e?.addEventListener("dragend",t=>{"IMG"===t.target.tagName&&(t.target.classList.remove("dragging"),this.draggedEditorImage=null,e.querySelectorAll(".drop-indicator").forEach(e=>e.remove()),e.querySelectorAll(".drop-zone-active").forEach(e=>e.classList.remove("drop-zone-active")))}),e?.addEventListener("dragover",t=>{if(t.preventDefault(),this.draggedEditorImage){const n=t.target.closest("img:not(.dragging)");if(e.querySelectorAll(".drop-indicator").forEach(e=>e.remove()),e.querySelectorAll(".drop-zone-active").forEach(e=>e.classList.remove("drop-zone-active")),n&&n!==this.draggedEditorImage){n.classList.add("drop-zone-active");const a=n.getBoundingClientRect(),i=e.getBoundingClientRect(),r=t.clientX,s=t.clientY,o=a.left+a.width/2,l=a.top+a.height/2,d=n.closest(".image-grid-container"),c=document.createElement("div");if(c.className="drop-indicator",c.style.position="absolute",c.style.backgroundColor="#00c8ff",c.style.borderRadius="2px",c.style.zIndex="1000",c.style.pointerEvents="none",d){const t=r<o,n=s<l,d=(s-a.top)/a.height;a.left,a.width;d<.3||d>.7?(c.style.height="4px",c.style.width=a.width+"px",c.style.left=a.left-i.left+"px",n?(c.style.top=a.top-i.top+e.scrollTop-4+"px",c.dataset.position="before",c.dataset.axis="vertical"):(c.style.top=a.bottom-i.top+e.scrollTop+"px",c.dataset.position="after",c.dataset.axis="vertical")):(c.style.width="4px",c.style.height=a.height+"px",c.style.top=a.top-i.top+e.scrollTop+"px",t?(c.style.left=a.left-i.left-4+"px",c.dataset.position="before",c.dataset.axis="horizontal"):(c.style.left=a.right-i.left+"px",c.dataset.position="after",c.dataset.axis="horizontal"))}else c.style.width="4px",c.style.height=a.height+"px",c.style.top=a.top-i.top+e.scrollTop+"px",r<o?(c.style.left=a.left-i.left-4+"px",c.dataset.position="before"):(c.style.left=a.right-i.left+"px",c.dataset.position="after");e.style.position="relative",e.appendChild(c)}}else e.classList.add("drag-over")}),e?.addEventListener("dragleave",t=>{e.contains(t.relatedTarget)||(e.classList.remove("drag-over"),e.querySelectorAll(".drop-indicator").forEach(e=>e.remove()),e.querySelectorAll(".drop-zone-active").forEach(e=>e.classList.remove("drop-zone-active")))}),e?.addEventListener("drop",t=>{if(t.preventDefault(),e.classList.remove("drag-over"),e.querySelectorAll(".drop-indicator").forEach(e=>e.remove()),e.querySelectorAll(".drop-zone-active").forEach(e=>e.classList.remove("drop-zone-active")),this.draggedEditorImage){const e=t.target.closest("img:not(.dragging)");return e&&e!==this.draggedEditorImage&&this.handleImageDropOnImage(this.draggedEditorImage,e,t),void(this.draggedEditorImage=null)}const n=t.dataTransfer.files;if(n.length>0){const e=n[0];if(e.type.startsWith("image/"))return void this.insertImageFromFile(e)}const a=t.dataTransfer.getData("text/uri-list")||t.dataTransfer.getData("text/plain");a&&(a.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)||a.startsWith("data:image"))&&this.insertImageAtCursor(a)}),e?.addEventListener("click",t=>{const n=t.target;if("IMG"===n.tagName)this.selectEditorImage(n);else if(n.classList.contains("image-grid-container"))this.selectEditorGrid(n);else if(n.closest(".video-container")||n.closest(".youtube-embed")){const t=n.closest(".video-container")||n.closest(".youtube-embed");if(n.closest(".video-toolbar"))return;this.deselectEditorImages(),this.deselectEditorGrids(),e.querySelectorAll(".video-container.selected, .youtube-embed.selected").forEach(e=>{e.classList.remove("selected"),e.style.outline="",e.style.outlineOffset="";const t=e.querySelector(".video-toolbar");t&&t.remove()}),t.classList.add("selected"),t.style.outline="2px solid var(--admin-primary, #ffd166)",t.style.outlineOffset="-2px",this.createVideoToolbar(t)}else this.deselectEditorImages(),this.deselectEditorGrids(),e.querySelectorAll(".video-container.selected, .youtube-embed.selected").forEach(e=>{e.classList.remove("selected"),e.style.outline="",e.style.outlineOffset="";const t=e.querySelector(".video-toolbar");t&&t.remove()})}),e?.addEventListener("dblclick",e=>{const t=e.target;"IMG"===t.tagName&&(e.preventDefault(),this.openImageResizeModal(t))})}deleteSelectedImage(e){const t=e.closest(".image-grid-container");if(t){let n=e;e.parentElement.classList.contains("image-resize-wrapper")&&(n=e.parentElement),n.parentElement&&n.parentElement!==t&&["FIGURE","DIV"].includes(n.parentElement.tagName)&&n.parentElement.parentElement===t&&(n=n.parentElement),n.remove();const a=t.querySelectorAll("img");if(0===a.length)t.remove(),this.showToast("Galer√≠a eliminada","success");else if(1===a.length){const e=a[0],n=document.createElement("img");n.src=e.src,n.alt=e.alt||"",n.className="editor-image resizable",n.draggable=!0,n.style.maxWidth="100%",n.style.height="auto",e.style.width&&(n.style.width=e.style.width);const i=document.createElement("p");i.appendChild(n),t.parentElement.insertBefore(i,t),t.remove(),this.showToast("Imagen eliminada, galer√≠a deshecha","success")}else{const e=parseInt(t.className.match(/cols-(\d+)/)?.[1]||2);a.length<e&&(t.className=t.className.replace(/cols-\d+/,`cols-${a.length}`)),this.showToast("Imagen eliminada de la galer√≠a","success")}}else{let t=e;e.parentElement.classList.contains("image-resize-wrapper")&&(t=e.parentElement),"FIGURE"===t.parentElement.tagName&&(t=t.parentElement),"P"===t.parentElement.tagName&&1===t.parentElement.childNodes.length&&(t=t.parentElement),t.remove(),this.showToast("Imagen eliminada","success")}this.saveEditorState()}deleteSelectedGrid(e){e.remove(),this.showToast("Galer√≠a eliminada","success"),this.saveEditorState()}handleImageDropOnImage(e,t,n){const a=document.getElementById("article-editor"),i=a.querySelector(".drop-indicator"),r=i?.dataset.position||"after",s=i?.dataset.axis||"horizontal";let o=e;e.parentElement.classList.contains("image-resize-wrapper")&&(o=e.parentElement);const l=e.closest(".image-grid-container");let d=t;t.parentElement.classList.contains("image-resize-wrapper")&&(d=t.parentElement);const c=t.closest(".image-grid-container"),m="before"===r;if(l&&c&&l===c)return m?c.insertBefore(o,d):c.insertBefore(o,d.nextSibling),this.saveEditorState(),void this.showToast("Imagen reordenada","success");if(l&&!c){const t=this.createCleanImage(e),n=document.createElement("p");n.appendChild(t);let i=d;for(;i.parentElement&&i.parentElement!==a;)i=i.parentElement;m?i.parentElement.insertBefore(n,i):i.parentElement.insertBefore(n,i.nextSibling),o.remove();const r=l.querySelectorAll("img");if(0===r.length)l.remove();else if(1===r.length){const e=r[0],t=this.createCleanImage(e),n=document.createElement("p");n.appendChild(t),l.parentElement.insertBefore(n,l),l.remove()}else{const e=parseInt(l.className.match(/cols-(\d+)/)?.[1]||2);r.length<e&&(l.className=l.className.replace(/cols-\d+/,`cols-${Math.min(r.length,4)}`))}return this.saveEditorState(),void this.showToast("Imagen sacada de la galer√≠a","success")}if(!l&&c){const t=this.createCleanImage(e);m?c.insertBefore(t,d):c.insertBefore(t,d.nextSibling);const n=c.querySelectorAll("img").length,i=Math.min(n,4);c.className=c.className.replace(/cols-\d+/,`cols-${i}`);let r=o;for(;r.parentElement&&r.parentElement!==a&&1===r.parentElement.childNodes.length;)r=r.parentElement;return r.remove(),this.saveEditorState(),void this.showToast("Imagen agregada a la galer√≠a","success")}if(!l&&!c){let n=d;for(;n.parentElement&&n.parentElement!==a;)n=n.parentElement;let i=o;for(;i.parentElement&&i.parentElement!==a&&1===i.parentElement.childNodes.length;)i=i.parentElement;if("vertical"===s){const t=this.createCleanImage(e),a=document.createElement("p");a.appendChild(t),m?n.parentElement.insertBefore(a,n):n.parentElement.insertBefore(a,n.nextSibling),i.remove(),this.saveEditorState(),this.showToast("Imagen movida","success")}else{const a=document.createElement("div");a.className="image-grid-container cols-2",a.style.gap="8px";const r=this.createCleanImage(t),s=this.createCleanImage(e);m?(a.appendChild(s),a.appendChild(r)):(a.appendChild(r),a.appendChild(s)),n.parentElement.insertBefore(a,n),n.remove(),i.remove(),this.saveEditorState(),this.showToast("Galer√≠a creada con 2 im√°genes","success")}return}if(l&&c&&l!==c){const t=this.createCleanImage(e);m?c.insertBefore(t,d):c.insertBefore(t,d.nextSibling);const n=c.querySelectorAll("img").length;c.className=c.className.replace(/cols-\d+/,`cols-${Math.min(n,4)}`),o.remove();const a=l.querySelectorAll("img");if(0===a.length)l.remove();else if(1===a.length){const e=a[0],t=this.createCleanImage(e),n=document.createElement("p");n.appendChild(t),l.parentElement.insertBefore(n,l),l.remove()}else{const e=parseInt(l.className.match(/cols-(\d+)/)?.[1]||2);a.length<e&&(l.className=l.className.replace(/cols-\d+/,`cols-${Math.min(a.length,4)}`))}this.saveEditorState(),this.showToast("Imagen movida entre galer√≠as","success")}}createCleanImage(e){const t=document.createElement("img");return t.src=e.src,t.alt=e.alt||"",t.className="editor-image resizable",t.draggable=!0,t.style.maxWidth="100%",t.style.height="auto",e.style.width&&(t.style.width=e.style.width),e.style.height&&"auto"!==e.style.height&&(t.style.height=e.style.height),t}setupEditorImages(){const e=document.getElementById("article-editor");e&&(e.querySelectorAll("img").forEach(e=>{e.draggable=!0,e.classList.contains("editor-image")||e.classList.add("editor-image"),e.classList.contains("resizable")||e.classList.add("resizable")}),e.querySelectorAll(".image-resize-wrapper").forEach(e=>{const t=e.querySelector("img");t&&e.parentElement.insertBefore(t,e),e.remove()}),e.querySelectorAll(".video-container, .youtube-embed").forEach(e=>{e.querySelector("iframe")||e.remove()}),this.deselectEditorImages(),this.deselectEditorGrids())}selectEditorGrid(e){this.deselectEditorImages(),this.deselectEditorGrids(),e.classList.add("selected")}deselectEditorGrids(){const e=document.getElementById("article-editor");e?.querySelectorAll(".image-grid-container.selected").forEach(e=>{e.classList.remove("selected")})}insertImageFromFile(e){const t=new FileReader;t.onload=e=>{this.insertImageAtCursor(e.target.result)},t.readAsDataURL(e)}insertImageAtCursor(e){const t=document.getElementById("article-editor");t.focus();const n=document.createElement("img");n.src=e,n.alt="",n.style.maxWidth="100%",n.style.height="auto",n.className="editor-image resizable",n.draggable=!0;const a=window.getSelection();if(a.rangeCount>0){const e=a.getRangeAt(0);e.deleteContents();const t=document.createElement("p");t.appendChild(n),e.insertNode(t),e.setStartAfter(t),e.collapse(!0),a.removeAllRanges(),a.addRange(e)}else t.appendChild(n);this.saveEditorState(),this.showToast("Imagen insertada","success")}selectEditorImage(e){this.deselectEditorImages(),this.deselectEditorGrids(),e.classList.add("selected");if(null!==e.closest(".image-grid-container"))return;let t;e.parentElement.classList.contains("image-resize-wrapper")?(t=e.parentElement,t.classList.add("has-selected")):(t=document.createElement("span"),t.className="image-resize-wrapper has-selected",t.contentEditable="false",e.parentElement.insertBefore(t,e),t.appendChild(e),["nw","ne","sw","se"].forEach(n=>{const a=document.createElement("span");a.className=`resize-handle ${n}`,a.dataset.position=n,t.appendChild(a),a.addEventListener("mousedown",t=>{t.preventDefault(),this.startImageResize(e,n,t)})})),t.classList.add("selected"),this.selectedImage=t,this.createImageToolbar(t)}deselectEditorImages(){const e=document.getElementById("article-editor");e?.querySelectorAll(".image-resize-wrapper.selected, .image-resize-wrapper.has-selected").forEach(e=>{e.classList.remove("selected","has-selected");const t=e.querySelector(".image-toolbar");t&&t.remove()}),e?.querySelectorAll("img.selected").forEach(e=>{e.classList.remove("selected")}),this.selectedImage=null}startImageResize(e,t,n){const a=e.offsetWidth,i=e.offsetHeight,r=n.clientX,s=(n.clientY,a/i),o=n=>{const i=n.clientX-r;n.clientY;let o,l;o=t.includes("e")?a+i:a-i,l=o/s,o>=50&&(e.style.width=o+"px",e.style.height="auto")},l=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",l)}openImageResizeModal(e){const t=document.getElementById("image-resize-modal"),n=document.getElementById("resize-preview-img"),a=document.getElementById("resize-width"),i=document.getElementById("resize-height"),r=document.getElementById("original-size");this.resizingImage=e,this.originalImageWidth=e.naturalWidth,this.originalImageHeight=e.naturalHeight,this.aspectRatio=this.originalImageWidth/this.originalImageHeight,this.lockAspectRatio=!0,n.src=e.src,r.textContent=`${this.originalImageWidth} x ${this.originalImageHeight}`;const s=e.offsetWidth||e.naturalWidth,o=e.offsetHeight||e.naturalHeight;a.value=Math.round(s),i.value=Math.round(o),document.getElementById("lock-aspect-ratio").classList.add("active"),t.classList.remove("hidden"),setTimeout(()=>a.select(),100)}setupImageResizeModal(){document.getElementById("image-resize-modal");const e=document.getElementById("resize-width"),t=document.getElementById("resize-height"),n=document.getElementById("lock-aspect-ratio"),a=document.getElementById("reset-size-btn"),i=document.getElementById("apply-resize-btn");n?.addEventListener("click",()=>{this.lockAspectRatio=!this.lockAspectRatio,n.classList.toggle("active",this.lockAspectRatio),this.lockAspectRatio&&e.value&&(t.value=Math.round(parseInt(e.value)/this.aspectRatio))}),e?.addEventListener("input",()=>{if(this.lockAspectRatio&&e.value){const n=parseInt(e.value);n>=CONFIG.MIN_IMAGE_SIZE&&(t.value=Math.round(n/this.aspectRatio))}}),t?.addEventListener("input",()=>{if(this.lockAspectRatio&&t.value){const n=parseInt(t.value);n>=CONFIG.MIN_IMAGE_SIZE&&(e.value=Math.round(n*this.aspectRatio))}}),a?.addEventListener("click",()=>{e.value=this.originalImageWidth,t.value=this.originalImageHeight}),i?.addEventListener("click",()=>{this.applyImageResize()}),e?.addEventListener("keydown",e=>{"Enter"===e.key&&this.applyImageResize()}),t?.addEventListener("keydown",e=>{"Enter"===e.key&&this.applyImageResize()})}applyImageResize(){const e=document.getElementById("resize-width"),t=document.getElementById("resize-height"),n=document.getElementById("image-resize-modal"),a=parseInt(e.value),i=parseInt(t.value);!a||a<CONFIG.MIN_IMAGE_SIZE?this.showToast(`El ancho m√≠nimo es ${CONFIG.MIN_IMAGE_SIZE}px`,"warning"):!i||i<CONFIG.MIN_IMAGE_SIZE?this.showToast(`El alto m√≠nimo es ${CONFIG.MIN_IMAGE_SIZE}px`,"warning"):(this.resizingImage&&(this.resizingImage.style.width=a+"px",this.resizingImage.style.height=this.lockAspectRatio?"auto":i+"px",this.showToast("Imagen redimensionada","success")),n.classList.add("hidden"),this.resizingImage=null)}executeEditorCommand(e){const t=document.getElementById("article-editor"),n=window.getSelection();let a=null;switch(n&&n.rangeCount>0&&(a=n.getRangeAt(0).cloneRange()),t.focus(),a&&t.contains(a.commonAncestorContainer)&&(n.removeAllRanges(),n.addRange(a)),e){case"undo":return void this.undo();case"redo":return void this.redo();case"bold":document.execCommand("bold",!1,null);break;case"italic":document.execCommand("italic",!1,null);break;case"underline":document.execCommand("underline",!1,null);break;case"h2":document.execCommand("formatBlock",!1,"h2");break;case"h3":document.execCommand("formatBlock",!1,"h3");break;case"p":document.execCommand("formatBlock",!1,"p");break;case"ul":document.execCommand("insertUnorderedList",!1,null);break;case"quote":{const e=window.getSelection();if(e.rangeCount>0){let t=e.getRangeAt(0).commonAncestorContainer;3===t.nodeType&&(t=t.parentNode);const n=t.closest("blockquote");if(n){const e=n.parentNode;for(;n.firstChild;)e.insertBefore(n.firstChild,n);e.removeChild(n)}else document.execCommand("formatBlock",!1,"blockquote")}break}case"link":return this.saveEditorSelection(),void this.showLinkModal();case"justifyLeft":this.selectedImage?this.setImageAlignment(this.selectedImage,"left"):document.execCommand("justifyLeft",!1,null);break;case"justifyCenter":this.selectedImage?this.setImageAlignment(this.selectedImage,"center"):document.execCommand("justifyCenter",!1,null);break;case"justifyRight":this.selectedImage?this.setImageAlignment(this.selectedImage,"right"):document.execCommand("justifyRight",!1,null);break;case"justifyFull":document.execCommand("justifyFull",!1,null);break;case"image":return void this.openImageModal();case"image-grid":return void this.openGridModal();case"gallery":return void this.openGalleryModal();case"youtube":return void this.insertYouTube();case"hr":document.execCommand("insertHTML",!1,"<hr>");break;case"clear":document.execCommand("removeFormat",!1,null);const e=window.getSelection();if(e.rangeCount>0){let t=e.getRangeAt(0).commonAncestorContainer;3===t.nodeType&&(t=t.parentNode);const n=t.closest("blockquote");if(n){const e=n.parentNode;for(;n.firstChild;)e.insertBefore(n.firstChild,n);e.removeChild(n)}t.closest("h1, h2, h3, h4, h5, h6")&&document.execCommand("formatBlock",!1,"p")}this.showToast("Formato limpiado","success")}this.saveEditorState(),this.updateToolbarState()}updateToolbarState(){document.querySelectorAll(".editor-toolbar button[data-command]").forEach(e=>{let t=!1;switch(e.dataset.command){case"bold":t=document.queryCommandState("bold");break;case"italic":t=document.queryCommandState("italic");break;case"underline":t=document.queryCommandState("underline");break;case"justifyLeft":t=document.queryCommandState("justifyLeft");break;case"justifyCenter":t=document.queryCommandState("justifyCenter");break;case"justifyRight":t=document.queryCommandState("justifyRight");break;case"justifyFull":t=document.queryCommandState("justifyFull")}e.classList.toggle("active",t)})}createFloatingToolbar(){if(document.getElementById("floating-toolbar"))return;const e=document.createElement("div");e.id="floating-toolbar",e.className="floating-toolbar",e.setAttribute("role","toolbar"),e.setAttribute("aria-label","Herramientas de formato de texto"),e.innerHTML='\n      <button data-cmd="bold" title="Negrita (Ctrl+B)" aria-label="Negrita">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>\n          <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>\n        </svg>\n      </button>\n      <button data-cmd="italic" title="Cursiva (Ctrl+I)" aria-label="Cursiva">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/>\n        </svg>\n      </button>\n      <button data-cmd="underline" title="Subrayado (Ctrl+U)" aria-label="Subrayado">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/><line x1="4" y1="21" x2="20" y2="21"/>\n        </svg>\n      </button>\n      <span class="floating-toolbar-divider"></span>\n      <button data-cmd="h2" title="T√≠tulo H2" aria-label="T√≠tulo H2">\n        <span class="ft-text">H2</span>\n      </button>\n      <button data-cmd="h3" title="Subt√≠tulo H3" aria-label="Subt√≠tulo H3">\n        <span class="ft-text">H3</span>\n      </button>\n      <button data-cmd="p" title="P√°rrafo" aria-label="P√°rrafo">\n        <span class="ft-text">P</span>\n      </button>\n      <span class="floating-toolbar-divider"></span>\n      <button data-cmd="justifyLeft" title="Alinear izquierda" aria-label="Alinear izquierda">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/>\n        </svg>\n      </button>\n      <button data-cmd="justifyCenter" title="Centrar" aria-label="Centrar">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <line x1="18" y1="10" x2="6" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="18" y1="18" x2="6" y2="18"/>\n        </svg>\n      </button>\n      <button data-cmd="justifyRight" title="Alinear derecha" aria-label="Alinear derecha">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <line x1="21" y1="10" x2="7" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="7" y2="18"/>\n        </svg>\n      </button>\n      <button data-cmd="justifyFull" title="Justificar" aria-label="Justificar">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>\n        </svg>\n      </button>\n      <span class="floating-toolbar-divider"></span>\n      <button data-cmd="link" title="Enlace (Ctrl+K)" aria-label="Enlace">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>\n          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>\n        </svg>\n      </button>\n      <button data-cmd="quote" title="Cita" aria-label="Cita">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M4.583 17.321C3.553 16.227 3 15 3 13.011c0-3.5 2.457-6.637 6.03-8.188l.893 1.378c-3.335 1.804-3.987 4.145-4.247 5.621.537-.278 1.24-.375 1.929-.311 1.804.167 3.226 1.648 3.226 3.489a3.5 3.5 0 0 1-3.5 3.5c-1.073 0-2.099-.49-2.748-1.179zm10 0C13.553 16.227 13 15 13 13.011c0-3.5 2.457-6.637 6.03-8.188l.893 1.378c-3.335 1.804-3.987 4.145-4.247 5.621.537-.278 1.24-.375 1.929-.311 1.804.167 3.226 1.648 3.226 3.489a3.5 3.5 0 0 1-3.5 3.5c-1.073 0-2.099-.49-2.748-1.179z"/>\n        </svg>\n      </button>\n      <button data-cmd="clear" title="Limpiar formato" aria-label="Limpiar formato">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">\n          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>\n        </svg>\n      </button>\n      <div class="floating-toolbar-arrow"></div>\n    ',e.querySelectorAll("button[data-cmd]").forEach(e=>{e.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation();const n=e.dataset.cmd;this.executeEditorCommand(n),this.updateFloatingToolbarState(),["h2","h3","p","quote","clear"].includes(n)&&this.hideFloatingToolbar()})}),document.body.appendChild(e)}showFloatingToolbar(){const e=document.getElementById("article-editor"),t=window.getSelection();if(!e||!t||t.isCollapsed||""===t.toString().trim())return void this.hideFloatingToolbar();if(!e.contains(t.anchorNode)||!e.contains(t.focusNode))return void this.hideFloatingToolbar();this.createFloatingToolbar();const n=document.getElementById("floating-toolbar");if(!n)return;const a=t.getRangeAt(0).getBoundingClientRect();let i=a.left+a.width/2-180,r=a.top-52;i<8&&(i=8),i+360>window.innerWidth-8&&(i=window.innerWidth-360-8),r<8?(r=a.bottom+10,n.classList.add("arrow-top"),n.classList.remove("arrow-bottom")):(n.classList.add("arrow-bottom"),n.classList.remove("arrow-top")),n.style.left=`${i}px`,n.style.top=`${r+window.scrollY}px`,n.classList.add("visible"),this.updateFloatingToolbarState()}hideFloatingToolbar(){const e=document.getElementById("floating-toolbar");e&&e.classList.remove("visible")}updateFloatingToolbarState(){const e=document.getElementById("floating-toolbar");e&&e.classList.contains("visible")&&e.querySelectorAll("button[data-cmd]").forEach(e=>{let t=!1;switch(e.dataset.cmd){case"bold":t=document.queryCommandState("bold");break;case"italic":t=document.queryCommandState("italic");break;case"underline":t=document.queryCommandState("underline");break;case"justifyLeft":t=document.queryCommandState("justifyLeft");break;case"justifyCenter":t=document.queryCommandState("justifyCenter");break;case"justifyRight":t=document.queryCommandState("justifyRight");break;case"justifyFull":t=document.queryCommandState("justifyFull")}e.classList.toggle("active",t)})}showLinkModal(){this.hideFloatingToolbar();const e=document.getElementById("link-modal");e&&e.remove();const t=window.getSelection(),n=t?t.toString().trim():"",a=document.createElement("div");a.id="link-modal",a.className="link-modal-overlay",a.innerHTML=`\n      <div class="link-modal-content">\n        <h3>\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>\n            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>\n          </svg>\n          Insertar enlace\n        </h3>\n        <div class="link-modal-field">\n          <label for="link-url-input">URL</label>\n          <input type="url" id="link-url-input" placeholder="https://ejemplo.com" autocomplete="off" spellcheck="false" />\n        </div>\n        <div class="link-modal-field">\n          <label for="link-text-input">Texto del enlace</label>\n          <input type="text" id="link-text-input" placeholder="${n||"Texto visible"}" value="${this.escapeHtml(n)}" />\n        </div>\n        <label class="link-modal-checkbox">\n          <input type="checkbox" id="link-new-tab" checked />\n          <span>Abrir en nueva pesta√±a</span>\n        </label>\n        <div class="link-modal-actions">\n          <button type="button" class="link-modal-btn cancel" id="link-cancel">Cancelar</button>\n          <button type="button" class="link-modal-btn confirm" id="link-confirm">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>\n              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>\n            </svg>\n            Insertar\n          </button>\n        </div>\n      </div>\n    `,document.body.appendChild(a),requestAnimationFrame(()=>a.classList.add("visible"));const i=document.getElementById("link-url-input"),r=document.getElementById("link-text-input"),s=document.getElementById("link-new-tab"),o=document.getElementById("link-confirm"),l=document.getElementById("link-cancel");setTimeout(()=>i.focus(),100);const d=()=>{a.classList.remove("visible"),setTimeout(()=>a.remove(),200)},c=()=>{const e=i.value.trim();if(!e)return this.showToast("La URL es requerida","warning"),void i.focus();if(!(/^https?:\/\//i.test(e)||e.startsWith("/")||e.startsWith("#")||e.startsWith("mailto:")))return this.showToast("URL inv√°lida. Usa http://, https://, / o mailto:","warning"),void i.focus();d(),this.restoreEditorSelection();const t=r.value.trim()||n||e,a=s.checked?' target="_blank" rel="noopener noreferrer"':"",o=window.getSelection();if(o&&!o.isCollapsed){if(document.execCommand("createLink",!1,e),s.checked){document.getElementById("article-editor").querySelectorAll(`a[href="${e}"]`).forEach(e=>{e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer")})}}else document.execCommand("insertHTML",!1,`<a href="${this.escapeHtml(e)}"${a}>${this.escapeHtml(t)}</a>`);this.showToast("Enlace insertado","success"),this.saveEditorState()};o.addEventListener("click",c),l.addEventListener("click",d),a.addEventListener("click",e=>{e.target===a&&d()});const m=e=>{"Enter"===e.key&&(e.preventDefault(),c()),"Escape"===e.key&&d()};i.addEventListener("keydown",m),r.addEventListener("keydown",m)}saveEditorSelection(){const e=document.getElementById("article-editor"),t=window.getSelection();if(t.rangeCount>0){const n=t.getRangeAt(0);if(e&&e.contains(n.commonAncestorContainer))return void(this.savedEditorRange=n.cloneRange())}this.savedEditorRange=null}insertAtSavedPosition(e){const t=document.getElementById("article-editor");if(!t)return!1;if(this.savedEditorRange){t.focus();const n=window.getSelection();n.removeAllRanges(),n.addRange(this.savedEditorRange);const a=document.createElement("div");a.innerHTML=e;const i=document.createDocumentFragment();let r;for(;a.firstChild;)r=i.appendChild(a.firstChild);if(this.savedEditorRange.deleteContents(),this.savedEditorRange.insertNode(i),r){const e=document.createRange();e.setStartAfter(r),e.collapse(!0),n.removeAllRanges(),n.addRange(e)}return this.savedEditorRange=null,!0}t.focus();const n=document.createElement("div");for(n.innerHTML=e;n.firstChild;)t.appendChild(n.firstChild);const a=window.getSelection(),i=document.createRange();return i.selectNodeContents(t),i.collapse(!1),a.removeAllRanges(),a.addRange(i),!1}openImageModal(){this.saveEditorSelection();document.getElementById("image-modal").classList.remove("hidden"),document.getElementById("modal-image-url").value="",document.getElementById("modal-image-alt").value="",document.getElementById("image-width").value="",document.getElementById("image-height").value="",document.getElementById("image-caption").checked=!1,document.getElementById("image-caption-text").value="",document.getElementById("image-caption-text").classList.add("hidden"),this.switchImageTab("url"),document.querySelectorAll(".align-btn").forEach(e=>{e.classList.toggle("active","center"===e.dataset.align)});const e=document.getElementById("drop-zone"),t=document.getElementById("upload-preview");e&&(e.style.display="block"),t&&t.classList.add("hidden"),this.currentImageSource="url",this.uploadedImageData=null}switchImageTab(e){document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".tab-content").forEach(t=>{t.classList.toggle("active",t.id===`tab-${e}`)}),this.currentImageSource=e}openGridModal(){this.saveEditorSelection();document.getElementById("grid-modal").classList.remove("hidden"),document.getElementById("grid-images").value="",this.gridImages=[],document.querySelectorAll(".col-btn").forEach(e=>{e.classList.toggle("active","2"===e.dataset.cols)}),document.querySelectorAll(".gap-btn").forEach(e=>{e.classList.toggle("active","8"===e.dataset.gap)}),this.gridCols=2,this.gridGap=8,this.updateGridImagesList(),this.updateGridLivePreview()}insertYouTube(){this.saveEditorSelection();const e=document.getElementById("youtube-modal"),t=document.getElementById("youtube-url"),n=document.getElementById("youtube-preview");if(!e)return;t.value="",n.innerHTML="",n.classList.add("hidden"),e.classList.remove("hidden"),t.focus();const a=()=>{const e=this.extractYouTubeId(t.value);e?(n.innerHTML=`\n          <iframe \n            src="https://www.youtube.com/embed/${e}?autoplay=0&rel=0" \n            title="Vista previa del video"\n            frameborder="0"\n            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"\n            allowfullscreen>\n          </iframe>\n        `,n.classList.remove("hidden")):(n.innerHTML="",n.classList.add("hidden"))};t.removeEventListener("input",t._handler),t._handler=a,t.addEventListener("input",a),this.selectedVideoSize="large",document.querySelectorAll(".video-size-btn").forEach(e=>{e.classList.toggle("active","large"===e.dataset.size),e.addEventListener("click",()=>{document.querySelectorAll(".video-size-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.selectedVideoSize=e.dataset.size})})}confirmYouTubeInsert(){const e=document.getElementById("youtube-modal"),t=document.getElementById("youtube-url").value;if(!t)return void this.showToast("Ingresa una URL de YouTube","warning");const n=this.extractYouTubeId(t);if(!n)return void this.showToast("URL de YouTube no v√°lida","error");e.classList.add("hidden");const a=`<div class="video-container youtube-embed ${this.selectedVideoSize?`video-${this.selectedVideoSize}`:"video-large"}">\n  <iframe \n    src="https://www.youtube.com/embed/${n}" \n    title="YouTube video" \n    frameborder="0" \n    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" \n    allowfullscreen>\n  </iframe>\n</div>`;document.getElementById("article-editor");this.insertAtSavedPosition(a+"<p><br></p>"),this.saveEditorState(),this.showToast("Video de YouTube insertado","success")}closeYouTubeModal(){const e=document.getElementById("youtube-modal");e&&e.classList.add("hidden")}createVideoToolbar(e){const t=e.querySelector(".video-toolbar");t&&t.remove();const n=document.createElement("div");n.className="video-toolbar",n.contentEditable="false";const a=e.classList.contains("video-small")?"small":e.classList.contains("video-medium")?"medium":e.classList.contains("video-large")?"large":"full";[{size:"small",label:"S",title:"Peque√±o (400px)"},{size:"medium",label:"M",title:"Mediano (560px)"},{size:"large",label:"L",title:"Grande (750px)"},{size:"full",label:"‚ñ¢",title:"Completo (100%)"}].forEach(({size:t,label:i,title:r})=>{const s=document.createElement("button");s.type="button",s.textContent=i,s.title=r,t===a&&s.classList.add("active"),s.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation()}),s.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),e.classList.remove("video-small","video-medium","video-large","video-full"),e.classList.add(`video-${t}`),n.querySelectorAll("button").forEach(e=>e.classList.remove("active")),s.classList.add("active"),this.saveEditorState();this.showToast(`Video: tama√±o ${{small:"peque√±o",medium:"mediano",large:"grande",full:"completo"}[t]}`,"success")}),n.appendChild(s)});const i=document.createElement("span");i.className="vt-divider",n.appendChild(i);const r=document.createElement("button");r.type="button",r.title="Eliminar video",r.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',r.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation()}),r.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.remove(),this.showToast("Video eliminado","success"),this.saveEditorState()}),n.appendChild(r),e.appendChild(n)}extractYouTubeId(e){if(!e)return null;const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/];for(const n of t){const t=e.match(n);if(t&&t[1])return t[1]}return null}updateGridImagesList(){const e=document.getElementById("grid-images-list"),t=document.getElementById("grid-count");if(e){if(0===this.gridImages.length)return e.innerHTML="",void(t&&(t.textContent="0 im√°genes"));e.innerHTML=this.gridImages.map((e,t)=>`\n      <div class="grid-image-item" data-index="${t}">\n        <img src="${e}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%23333%22 width=%2260%22 height=%2260%22/><text x=%2230%22 y=%2235%22 fill=%22%23666%22 text-anchor=%22middle%22 font-size=%2210%22>Error</text></svg>'">\n        <button type="button" class="remove-btn" data-index="${t}">\n          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">\n            <line x1="18" y1="6" x2="6" y2="18"/>\n            <line x1="6" y1="6" x2="18" y2="18"/>\n          </svg>\n        </button>\n      </div>\n    `).join(""),t&&(t.textContent=`${this.gridImages.length} imagen${1!==this.gridImages.length?"es":""}`),e.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=parseInt(e.dataset.index);this.gridImages.splice(n,1),this.syncGridTextarea(),this.updateGridImagesList(),this.updateGridLivePreview()})})}}updateGridLivePreview(){const e=document.getElementById("grid-live-preview");e&&(e.className=`grid-live-preview cols-${this.gridCols}`,e.style.gap=`${this.gridGap}px`,0!==this.gridImages.length?e.innerHTML=this.gridImages.map(e=>`<img src="${e}" alt="" onerror="this.style.background='#333'">`).join(""):e.innerHTML='\n        <div class="preview-empty">\n          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">\n            <rect x="3" y="3" width="7" height="7" rx="1"/>\n            <rect x="14" y="3" width="7" height="7" rx="1"/>\n            <rect x="3" y="14" width="7" height="7" rx="1"/>\n            <rect x="14" y="14" width="7" height="7" rx="1"/>\n          </svg>\n          <span>Agrega im√°genes para ver la vista previa</span>\n        </div>\n      ')}syncGridTextarea(){const e=document.getElementById("grid-images");e&&(e.value=this.gridImages.join("\n"))}parseGridTextarea(){const e=document.getElementById("grid-images");if(!e)return;let t=e.value;const n=[],a=/(https?:\/\/[^\s\n]+)/gi;let i;for(;null!==(i=a.exec(t));)n.push(i[1].trim());const r=/(data:image\/[^;]+;base64,[A-Za-z0-9+/=]+)/gi;for(;null!==(i=r.exec(t));)n.push(i[1].trim());if(0===n.length){const e=t.split("\n").map(e=>e.trim()).filter(e=>e&&(e.startsWith("http")||e.startsWith("data:")));n.push(...e)}this.gridImages=[...new Set(n)],this.updateGridImagesList(),this.updateGridLivePreview()}addGridImageFromFile(e){const t=new FileReader;t.onload=e=>{this.gridImages.push(e.target.result),this.syncGridTextarea(),this.updateGridImagesList(),this.updateGridLivePreview()},t.readAsDataURL(e)}setPreviewDevice(e){const t=document.querySelector(".preview-frame-container"),n=document.querySelectorAll(".device-btn");t&&(n.forEach(t=>{t.classList.toggle("active",t.dataset.device===e)}),t.className="preview-frame-container","desktop"!==e&&t.classList.add(e))}setupImageModals(){document.querySelectorAll("[data-close]").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.close;document.getElementById(t).classList.add("hidden")})}),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&e.classList.add("hidden")})}),document.addEventListener("keydown",e=>{if("Escape"===e.key&&document.querySelectorAll(".modal:not(.hidden)").forEach(e=>{e.classList.add("hidden")}),"Tab"===e.key){const t=document.querySelector(".modal:not(.hidden):not(.modal-confirm)");if(t){const n=t.querySelectorAll('button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]), a[href]');if(n.length){const t=n[0],a=n[n.length-1];e.shiftKey?document.activeElement===t&&(e.preventDefault(),a.focus()):document.activeElement===a&&(e.preventDefault(),t.focus())}}}});const e=document.getElementById("insert-youtube-btn");e&&e.addEventListener("click",()=>this.confirmYouTubeInsert());const t=document.getElementById("youtube-url");t&&t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),this.confirmYouTubeInsert())}),document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{this.switchImageTab(e.dataset.tab)})});const n=document.getElementById("drop-zone"),a=document.getElementById("modal-file-input"),i=document.getElementById("upload-preview");document.getElementById("uploaded-img");n?.addEventListener("click",()=>a?.click()),n?.addEventListener("dragover",e=>{e.preventDefault(),n.classList.add("drag-over")}),n?.addEventListener("dragleave",()=>{n.classList.remove("drag-over")}),n?.addEventListener("drop",e=>{e.preventDefault(),n.classList.remove("drag-over");const t=e.dataTransfer.files[0];t&&t.type.startsWith("image/")&&this.handleModalImageUpload(t)}),a?.addEventListener("change",e=>{const t=e.target.files[0];t&&this.handleModalImageUpload(t)}),document.getElementById("remove-upload")?.addEventListener("click",()=>{n.style.display="block",i?.classList.add("hidden"),this.uploadedImageData=null}),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById("image-width"),n=document.getElementById("image-height");switch(e.dataset.preset){case"small":t.value="300",n.value="";break;case"medium":t.value="600",n.value="";break;case"large":t.value="900",n.value="";break;case"full":t.value="100"}})}),document.querySelectorAll(".align-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".align-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active")})});const r=document.getElementById("image-caption"),s=document.getElementById("image-caption-text");r?.addEventListener("change",()=>{r.checked?(s?.classList.remove("hidden"),s?.focus()):s?.classList.add("hidden")}),document.getElementById("insert-image-btn")?.addEventListener("click",()=>{try{let e="";if("upload"===this.currentImageSource&&this.uploadedImageData?e=this.uploadedImageData:"url"===this.currentImageSource?e=document.getElementById("modal-image-url")?.value.trim():this.uploadedImageData&&(e=this.uploadedImageData),!e)return void this.showToast("Selecciona o ingresa una imagen primero","error");const t=document.getElementById("modal-image-alt")?.value.trim()||"",n=document.getElementById("image-width")?.value.trim(),a=document.getElementById("image-height")?.value.trim(),i=document.getElementById("image-caption")?.checked,r=document.getElementById("image-caption-text")?.value.trim()||t,s=document.querySelector(".align-btn.active")?.dataset.align||"center";let o="max-width: 100%;";n&&(o+=` width: ${n}px;`),a&&(o+=` height: ${a}px;`);let l="resizable-image";l+="left"===s?" align-left":"right"===s?" align-right":"float-left"===s?" float-left":"float-right"===s?" float-right":" align-center";let d="";d=i&&r?`<figure class="${l}">\n  <img src="${e}" alt="${t}" style="${o}">\n  <figcaption>${r}</figcaption>\n</figure>`:`<span class="${l}">\n  <img src="${e}" alt="${t}" style="${o}">\n</span>`;if(!document.getElementById("article-editor"))return this.showToast("Error: No se encontr√≥ el editor","error"),void console.error("[Image Insert] Editor element not found");this.insertAtSavedPosition(d+"<p><br></p>"),document.getElementById("image-modal").classList.add("hidden"),this.uploadedImageData=null,this.currentImageSource="url";const c=document.getElementById("drop-zone"),m=document.getElementById("upload-preview"),g=document.getElementById("modal-file-input");c&&(c.style.display="block"),m&&m.classList.add("hidden"),g&&(g.value=""),this.saveEditorState(),this.setupEditorImageHandlers(),this.showToast("Imagen insertada","success")}catch(e){console.error("[Image Insert] Error:",e),this.showToast(`Error al insertar imagen: ${e.message}`,"error")}});const o=document.getElementById("grid-drop-zone"),l=document.getElementById("grid-file-input");o?.addEventListener("click",()=>l?.click()),o?.addEventListener("dragover",e=>{e.preventDefault(),o.classList.add("drag-over")}),o?.addEventListener("dragleave",()=>{o.classList.remove("drag-over")}),o?.addEventListener("drop",e=>{e.preventDefault(),o.classList.remove("drag-over");Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/")).forEach(e=>this.addGridImageFromFile(e));const t=e.dataTransfer.getData("text/uri-list")||e.dataTransfer.getData("text/plain");t&&(t.startsWith("http")||t.startsWith("data:"))&&(this.gridImages.push(t),this.syncGridTextarea(),this.updateGridImagesList(),this.updateGridLivePreview())}),l?.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{e.type.startsWith("image/")&&this.addGridImageFromFile(e)}),l.value=""}),document.getElementById("grid-images")?.addEventListener("input",()=>{this.parseGridTextarea()}),document.getElementById("add-url-btn")?.addEventListener("click",()=>{const e=document.getElementById("grid-images"),t=prompt("Ingresa la URL de la imagen:");if(t&&t.trim()&&(t.startsWith("http")||t.startsWith("data:"))){const n=e.value.trim();e.value=n?`${n}\n${t.trim()}`:t.trim(),this.parseGridTextarea()}else t&&this.showToast("URL inv√°lida. Debe comenzar con http o https","error")}),document.getElementById("open-gallery-from-grid-btn")?.addEventListener("click",()=>{this.openGalleryForGrid()}),document.querySelectorAll(".col-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".col-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.gridCols=parseInt(e.dataset.cols),this.updateGridLivePreview()})}),document.querySelectorAll(".gap-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".gap-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.gridGap=parseInt(e.dataset.gap),this.updateGridLivePreview()})}),document.getElementById("insert-grid-btn")?.addEventListener("click",()=>{if(0===this.gridImages.length)return void this.showToast("Agrega al menos una imagen","error");const e=this.gridImages.map(e=>`<img src="${e}" alt="" draggable="true" class="editor-image resizable">`).join("\n  "),t=`<div class="image-grid-container cols-${this.gridCols}" style="gap: ${this.gridGap}px;">\n  ${e}\n</div><p><br></p>`;document.getElementById("grid-modal").classList.add("hidden"),this.insertAtSavedPosition(t),this.saveEditorState(),this.showToast(`Galer√≠a de ${this.gridImages.length} im√°genes insertada`,"success")}),document.querySelectorAll(".device-btn").forEach(e=>{e.addEventListener("click",()=>{this.setPreviewDevice(e.dataset.device)})}),document.getElementById("close-preview-modal")?.addEventListener("click",()=>{document.getElementById("preview-modal").classList.add("hidden")})}handleModalImageUpload(e){const t=document.getElementById("drop-zone"),n=document.getElementById("upload-preview"),a=document.getElementById("uploaded-img");if(!e||!e.type.startsWith("image/"))return void this.showToast("Por favor selecciona una imagen v√°lida","error");const i=new FileReader;i.onload=e=>{this.uploadedImageData=e.target.result,a&&(a.src=e.target.result),t&&(t.style.display="none"),n&&n.classList.remove("hidden"),this.switchImageTab("upload")},i.onerror=()=>{this.showToast("Error al leer el archivo","error")},i.readAsDataURL(e)}setupEditorImageHandlers(){const e=document.getElementById("article-editor");e&&(e.dataset.imageHandlersSetup||(e.dataset.imageHandlersSetup="true",e.addEventListener("click",t=>{if(t.target.closest(".image-toolbar"))return;const n=t.target.closest(".resizable-image, .image-resize-wrapper, figure");e.querySelectorAll(".resizable-image.selected, .image-resize-wrapper.selected, .image-resize-wrapper.has-selected, figure.selected").forEach(e=>{e.classList.remove("selected","has-selected");const t=e.querySelector(".image-toolbar");t&&t.remove()}),n?(t.stopPropagation(),n.classList.add("selected"),this.selectedImage=n,this.createImageToolbar(n)):this.selectedImage=null}),e.addEventListener("keydown",e=>{"Delete"!==e.key&&"Backspace"!==e.key||!this.selectedImage||(e.preventDefault(),this.selectedImage.remove(),this.selectedImage=null,this.showToast("Imagen eliminada","success"),this.saveEditorState())})))}createImageToolbar(e){const t=e.querySelector(".image-toolbar");t&&t.remove();const n=document.createElement("div");n.className="image-toolbar",n.contentEditable="false";const a=e.classList.contains("align-left")?"left":e.classList.contains("align-right")?"right":e.classList.contains("float-left")?"left":e.classList.contains("float-right")?"right":"center";[{align:"left",icon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="17" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/></svg>',title:"Alinear izquierda"},{align:"center",icon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="10" x2="6" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="18" y1="14" x2="6" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/></svg>',title:"Centrar"},{align:"right",icon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="21" y1="10" x2="7" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="7" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/></svg>',title:"Alinear derecha"},{align:"delete",icon:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',title:"Eliminar imagen"}].forEach(t=>{const i=document.createElement("button");i.type="button",i.innerHTML=t.icon,i.title=t.title,t.align===a&&i.classList.add("active"),i.addEventListener("click",a=>{if(a.preventDefault(),a.stopPropagation(),"delete"===t.align)return e.remove(),this.selectedImage=null,this.showToast("Imagen eliminada","success"),void this.saveEditorState();this.setImageAlignment(e,t.align),n.querySelectorAll("button").forEach(e=>e.classList.remove("active")),i.classList.add("active")}),i.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation()}),n.appendChild(i)}),e.appendChild(n)}setImageAlignment(e,t){if(e){switch(e.classList.remove("align-left","align-center","align-right","float-left","float-right"),t){case"left":e.classList.add("align-left");break;case"center":e.classList.add("align-center");break;case"right":e.classList.add("align-right")}this.showToast("Imagen alineada "+("left"===t?"a la izquierda":"right"===t?"a la derecha":"al centro"),"success"),this.saveEditorState()}}setupGalleryModal(){document.getElementById("gallery-search")?.addEventListener("input",e=>{this.filterGalleryImages(e.target.value)}),document.getElementById("gallery-refresh-btn")?.addEventListener("click",()=>{this.loadGalleryImages()}),document.getElementById("gallery-upload-btn")?.addEventListener("click",()=>{this.openGalleryUploadModal()}),this.setupGalleryUploadModal()}setupGalleryUploadModal(){const e=document.getElementById("gallery-dropzone"),t=document.getElementById("gallery-file-input"),n=document.getElementById("upload-preview-container"),a=(document.getElementById("upload-preview-img"),document.getElementById("remove-upload-preview")),i=document.getElementById("confirm-upload-btn");e?.addEventListener("click",()=>t?.click()),e?.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e?.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e?.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over");const n=t.dataTransfer.files[0];n&&n.type.startsWith("image/")&&this.handleGalleryUploadPreview(n)}),t?.addEventListener("change",e=>{const n=e.target.files[0];n&&this.handleGalleryUploadPreview(n),t.value=""}),a?.addEventListener("click",()=>{this.galleryUploadData=null,e.style.display="",n?.classList.add("hidden"),i.disabled=!0}),i?.addEventListener("click",()=>{this.uploadImageToGallery()})}handleGalleryUploadPreview(e){const t=document.getElementById("gallery-dropzone"),n=document.getElementById("upload-preview-container"),a=document.getElementById("upload-preview-img"),i=document.getElementById("confirm-upload-btn"),r=new FileReader;r.onload=r=>{this.galleryUploadData={filename:e.name,content:r.target.result.split(",")[1],type:e.type},a.src=r.target.result,t.style.display="none",n?.classList.remove("hidden"),i.disabled=!1},r.readAsDataURL(e)}async uploadImageToGallery(){if(!this.galleryUploadData)return void this.showToast("Error: datos de imagen no disponibles","error");if(!this.user)return void this.showToast("Sesi√≥n expirada. Por favor, vuelve a iniciar sesi√≥n.","error");const e=document.getElementById("confirm-upload-btn");e.disabled=!0,e.innerHTML='<span class="spinner"></span> Subiendo...';try{const e=await this.getAccessToken(),t=await fetch("/api/upload-image.php",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},credentials:"include",body:JSON.stringify(this.galleryUploadData)}),n=await t.json();if(!t.ok)throw new Error(n.error||"Error al subir imagen");this.showToast(`Imagen subida: ${n.filename}`,"success"),document.getElementById("gallery-upload-modal").classList.add("hidden"),this.resetGalleryUploadModal(),this.loadGalleryImages()}catch(e){console.error("Error uploading image:",e),this.showToast("Error al subir imagen: "+e.message,"error")}finally{e.disabled=!1,e.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>\n          <polyline points="17 8 12 3 7 8"/>\n          <line x1="12" y1="3" x2="12" y2="15"/>\n        </svg>\n        Subir\n      '}}resetGalleryUploadModal(){this.galleryUploadData=null;const e=document.getElementById("gallery-dropzone"),t=document.getElementById("upload-preview-container"),n=document.getElementById("confirm-upload-btn");e&&(e.style.display=""),t?.classList.add("hidden"),n&&(n.disabled=!0)}openGalleryModal(){document.getElementById("gallery-modal").classList.remove("hidden"),document.getElementById("gallery-search").value="",this.gallerySelectMode=!1,this.loadGalleryImages()}openGalleryForGrid(){document.getElementById("gallery-modal").classList.remove("hidden"),document.getElementById("gallery-search").value="",this.gallerySelectMode=!0,this.loadGalleryImages()}openGalleryUploadModal(){this.resetGalleryUploadModal(),document.getElementById("gallery-upload-modal").classList.remove("hidden")}async loadGalleryImages(){const e=document.getElementById("gallery-grid"),t=document.getElementById("gallery-count");e.innerHTML='\n      <div class="gallery-loading">\n        <span class="spinner"></span>\n        <span>Cargando im√°genes...</span>\n      </div>\n    ';try{const e=await this.getAccessToken(),n=await fetch("/api/list-images.php",{headers:{Authorization:`Bearer ${e}`},credentials:"include"}),a=await n.json();if(!n.ok)throw new Error(a.error||"Error al cargar im√°genes");if(this.galleryImages=a.images||[],this.renderGalleryImages(this.galleryImages),t){const e=this.gallerySelectMode?" ‚Ä¢ Modo selecci√≥n (clic para agregar)":"";t.textContent=`${this.galleryImages.length} imagen${1!==this.galleryImages.length?"es":""}${e}`}}catch(t){console.error("Error loading gallery:",t),e.innerHTML=`\n        <div class="gallery-empty">\n          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n            <circle cx="12" cy="12" r="10"/>\n            <line x1="12" y1="8" x2="12" y2="12"/>\n            <line x1="12" y1="16" x2="12.01" y2="16"/>\n          </svg>\n          <p>Error al cargar im√°genes</p>\n          <span>${t.message}</span>\n        </div>\n      `}}renderGalleryImages(e){const t=document.getElementById("gallery-grid");e&&0!==e.length?(t.innerHTML=e.map(e=>`\n      <div class="gallery-item" data-url="${e.url}" data-name="${e.name}">\n        <img src="${e.url}" alt="${e.name}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%23333%22 width=%2260%22 height=%2260%22/><text x=%2230%22 y=%2235%22 fill=%22%23666%22 text-anchor=%22middle%22 font-size=%2210%22>Error</text></svg>'">\n        <div class="item-overlay">\n          <span class="item-name">${e.name}</span>\n        </div>\n        <span class="copy-indicator">¬°URL Copiada!</span>\n      </div>\n    `).join(""),t.querySelectorAll(".gallery-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.url;this.gallerySelectMode?(this.gridImages.push(t),this.syncGridTextarea(),this.updateGridImagesList(),this.updateGridLivePreview(),this.showToast("Imagen agregada al grid","success"),e.classList.add("copied"),setTimeout(()=>e.classList.remove("copied"),500)):navigator.clipboard.writeText(t).then(()=>{e.classList.add("copied"),setTimeout(()=>e.classList.remove("copied"),1500),this.showToast("URL copiada al portapapeles","success")}).catch(()=>{this.showToast("Error al copiar URL","error")})})})):t.innerHTML='\n        <div class="gallery-empty">\n          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n            <rect x="3" y="3" width="18" height="18" rx="2"/>\n            <circle cx="8.5" cy="8.5" r="1.5"/>\n            <path d="M21 15l-5-5L5 21"/>\n          </svg>\n          <p>No hay im√°genes</p>\n          <span>Sube tu primera imagen para empezar</span>\n        </div>\n      '}filterGalleryImages(e){const t=e.toLowerCase().trim();if(!t)return void this.renderGalleryImages(this.galleryImages);const n=this.galleryImages.filter(e=>e.name.toLowerCase().includes(t));this.renderGalleryImages(n)}async navigateTo(e){if("new-article"===this.currentSection&&"new-article"!==e){const e=document.getElementById("article-editor"),t=document.getElementById("article-title")?.value,n=e&&""!==e.innerHTML.trim()&&"<br>"!==e.innerHTML;if((t||n)&&!this.editingArticle&&!this.contentSaved){if(!await this.showConfirmModal("Cambios sin guardar","Tienes cambios que no se han guardado. ¬øEst√°s seguro de que deseas salir?","Salir sin guardar","warning"))return}this.stopAutoSave(),this.contentSaved=!1}this.currentSection=e,document.querySelectorAll(".nav-item").forEach(t=>{t.classList.toggle("active",t.dataset.section===e)}),document.querySelectorAll(".content-section").forEach(t=>{t.classList.toggle("active",t.id===`section-${e}`)});const t={dashboard:"Dashboard",articles:"Art√≠culos",drafts:"Borradores","new-article":this.editingArticle?"Editar Art√≠culo":"Nuevo Art√≠culo",media:"Multimedia"};document.getElementById("section-title").textContent=t[e]||"Dashboard",document.querySelector(".admin-sidebar")?.classList.remove("open"),"new-article"!==e||this.editingArticle||this.resetArticleForm()}handleAction(e){switch(e){case"new-article":this.editingArticle=null,this.resetArticleForm(),this.navigateTo("new-article");break;case"upload-media":this.navigateTo("media"),document.getElementById("upload-media-btn")?.click()}}async loadArticles(){try{const e=await fetch("/blog/data/articles.json?t="+Date.now());if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json(),n=t.articles||[];this.articles=n.filter(e=>"draft"!==e.status),this.categories=t.categories||[],await this.loadDrafts(),this.updateDashboardStats(),this.renderArticlesTable(),this.renderDraftsTable(),this.renderRecentArticles(),this.renderRecentDrafts(),this.renderActivityLog(),this.renderPublishChart(),this.renderCategoriesBreakdown(),this.renderBlogHealth(),this.updateDraftsCount()}catch(e){console.error("Error loading articles:",e),this.showToast("Error al cargar art√≠culos. Verifica tu conexi√≥n.","error"),this.articles=[],this.drafts=[],this.categories=[]}}async loadDrafts(){try{const e=await fetch("/api/get-drafts.php?t="+Date.now(),{credentials:"include"});if(!e.ok){const e=await fetch("/blog/data/drafts.json?t="+Date.now());if(e.ok){const t=await e.json();this.drafts=t.drafts||[]}else this.drafts=[];return}const t=await e.json();this.drafts=t.drafts||[]}catch(e){console.warn("Could not load drafts:",e),this.drafts=[]}}updateDraftsCount(){const e=document.getElementById("drafts-count");e&&(e.textContent=this.drafts.length,e.style.display=this.drafts.length>0?"inline-flex":"none")}updateDashboardStats(){const e=document.getElementById("stat-articles"),t=document.getElementById("stat-drafts"),n=document.getElementById("stat-featured"),a=document.getElementById("stat-trending");e&&(e.textContent=this.articles.length),t&&(t.textContent=this.drafts.length),n&&(n.textContent=this.articles.filter(e=>e.featured).length),a&&(a.textContent=this.articles.filter(e=>e.trending).length)}renderArticlesTable(){const e=document.getElementById("articles-table-body");e&&(0!==this.articles.length?e.innerHTML=this.articles.map(e=>`\n      <tr data-id="${e.id}">\n        <td>\n          <div class="article-cell">\n            <img src="${e.image}" alt="" class="article-thumb" \n                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 40%22><rect fill=%22%232d3142%22 width=%2260%22 height=%2240%22/></svg>'">\n            <div class="article-info">\n              <strong>${this.escapeHtml(e.title)}</strong>\n              <span>${e.slug}</span>\n            </div>\n          </div>\n        </td>\n        <td>\n          <span class="category-badge category-${e.category}">\n            ${e.categoryDisplay||e.category}\n          </span>\n        </td>\n        <td>${this.formatDate(e.publishDate)}</td>\n        <td>\n          <div class="table-actions">\n            <button class="edit-btn" onclick="admin.editArticle('${e.id}')" title="Editar">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </button>\n            <button class="delete-btn" onclick="admin.deleteArticle('${e.id}')" title="Eliminar">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `).join(""):e.innerHTML='<tr><td colspan="4" class="empty-state">No hay art√≠culos</td></tr>')}renderDraftsTable(){const e=document.getElementById("drafts-table-body");e&&(0!==this.drafts.length?e.innerHTML=this.drafts.map(e=>`\n      <tr data-id="${e.id}" class="draft-row">\n        <td>\n          <div class="article-cell">\n            <div class="draft-icon">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </div>\n            <div class="article-info">\n              <strong>${this.escapeHtml(e.title)}</strong>\n              <span>${e.slug||"sin-slug"}</span>\n            </div>\n          </div>\n        </td>\n        <td>\n          <span class="category-badge category-${e.category}">\n            ${e.categoryDisplay||e.category}\n          </span>\n        </td>\n        <td>${this.formatDate(e.lastModified||e.publishDate)}</td>\n        <td>\n          <div class="table-actions">\n            <button class="publish-btn" onclick="admin.publishDraft('${e.id}')" title="Publicar borrador">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M22 2L11 13"/>\n                <path d="M22 2l-7 20-4-9-9-4 20-7z"/>\n              </svg>\n            </button>\n            <button class="edit-btn" onclick="admin.editArticle('${e.id}')" title="Continuar editando">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </button>\n            <button class="delete-btn" onclick="admin.deleteArticle('${e.id}')" title="Eliminar">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `).join(""):e.innerHTML='\n        <tr>\n          <td colspan="4" class="empty-state">\n            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 1rem;">\n              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n            </svg>\n            <p>No hay borradores</p>\n            <span>Los art√≠culos que guardes como borrador aparecer√°n aqu√≠</span>\n          </td>\n        </tr>')}renderRecentArticles(){const e=document.getElementById("recent-articles-list");if(!e)return;const t=this.articles.slice(0,CONFIG.RECENT_ARTICLES_LIMIT);0!==t.length?e.innerHTML=t.map(e=>`\n      <div class="recent-article-item">\n        <img src="${e.image}" alt="" \n             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 50 35%22><rect fill=%22%232d3142%22 width=%2250%22 height=%2235%22/></svg>'">\n        <div class="recent-article-info">\n          <strong>${this.escapeHtml(e.title)}</strong>\n          <div class="recent-article-meta">\n            <span class="recent-article-date">${this.formatDate(e.publishDate)}</span>\n            <span class="recent-article-category">${e.category||"Sin categor√≠a"}</span>\n          </div>\n        </div>\n        <div class="recent-article-actions">\n          <a href="${e.content}" target="_blank" class="action-icon" title="Ver art√≠culo">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>\n              <polyline points="15 3 21 3 21 9"/>\n              <line x1="10" y1="14" x2="21" y2="3"/>\n            </svg>\n          </a>\n          <button class="action-icon" title="Editar" onclick="admin.editArticle('${e.id}')">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n            </svg>\n          </button>\n          <button class="action-icon danger" title="Eliminar" onclick="admin.deleteArticle('${e.id}')">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <polyline points="3 6 5 6 21 6"/>\n              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `).join(""):e.innerHTML='<p class="empty-state">No hay art√≠culos a√∫n</p>'}renderRecentDrafts(){const e=document.getElementById("recent-drafts-list");if(!e)return;const t=document.getElementById("stat-drafts");if(t&&(t.textContent=this.drafts.length),0===this.drafts.length)return void(e.innerHTML='<p class="empty-state">No hay borradores</p>');const n=this.drafts.slice(0,5);e.innerHTML=n.map(e=>`\n      <div class="draft-item" onclick="admin.editArticle('${e.id}')">\n        <div class="draft-item-icon">\n          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n          </svg>\n        </div>\n        <div class="draft-item-info">\n          <strong>${this.escapeHtml(e.title)}</strong>\n          <span>${this.formatDate(e.modifiedDate||e.publishDate)}</span>\n        </div>\n      </div>\n    `).join("")}renderActivityLog(){const e=document.getElementById("activity-log-list");if(!e)return;const t=[];this.articles.forEach(e=>{t.push({type:"publish",title:e.title,date:new Date(e.publishDate),icon:"publish"}),e.modifiedDate&&e.modifiedDate!==e.publishDate&&t.push({type:"edit",title:e.title,date:new Date(e.modifiedDate),icon:"edit"})}),this.drafts.forEach(e=>{t.push({type:"draft",title:e.title,date:new Date(e.modifiedDate||e.publishDate),icon:"draft"})}),t.sort((e,t)=>t.date-e.date);const n=t.slice(0,8);if(0===n.length)return void(e.innerHTML='<p class="empty-state">No hay actividad reciente</p>');const a={publish:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>\n        <polyline points="22 4 12 14.01 9 11.01"/>\n      </svg>',edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n      </svg>',draft:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>\n        <polyline points="14 2 14 8 20 8"/>\n      </svg>'},i={publish:"Publicado",edit:"Editado",draft:"Borrador guardado"};e.innerHTML=n.map(e=>`\n      <div class="activity-item">\n        <div class="activity-icon ${e.icon}">${a[e.icon]}</div>\n        <div class="activity-info">\n          <span class="activity-title">${i[e.type]}: <strong>${this.escapeHtml(e.title.substring(0,40))}${e.title.length>40?"...":""}</strong></span>\n          <span class="activity-time">${this.getRelativeTime(e.date)}</span>\n        </div>\n      </div>\n    `).join("")}getRelativeTime(e){const t=new Date-e,n=Math.floor(t/6e4),a=Math.floor(t/36e5),i=Math.floor(t/864e5);return n<1?"Justo ahora":n<60?`Hace ${n} min`:a<24?`Hace ${a}h`:i<7?`Hace ${i} d√≠a${i>1?"s":""}`:this.formatDate(e)}renderPublishChart(){const e=document.getElementById("publish-chart"),t=document.getElementById("chart-legend");if(!e||!t)return;const n=[],a=new Date;for(let e=5;e>=0;e--){const t=new Date(a.getFullYear(),a.getMonth()-e,1);n.push({month:t.getMonth(),year:t.getFullYear(),label:t.toLocaleDateString("es",{month:"short"}),count:0})}this.articles.forEach(e=>{const t=new Date(e.publishDate),a=n.find(e=>e.month===t.getMonth()&&e.year===t.getFullYear());a&&a.count++});const i=Math.max(...n.map(e=>e.count),1);e.innerHTML=n.map(e=>{const t=e.count/i*100;return`<div class="chart-bar" style="height: ${Math.max(t,4)}%" data-count="${e.count}"></div>`}).join(""),t.innerHTML=n.map(e=>`<span>${e.label}</span>`).join("")}renderCategoriesBreakdown(){const e=document.getElementById("categories-breakdown");if(!e)return;const t={};this.articles.forEach(e=>{const n=e.category||"sin-categoria";t[n]=(t[n]||0)+1});const n=Object.entries(t).sort((e,t)=>t[1]-e[1]),a=this.articles.length||1;if(0===n.length)return void(e.innerHTML='<p class="empty-state">Sin datos de categor√≠as</p>');const i=["#ffd166","#e76f51","#10b981","#8b5cf6","#06b6d4","#f59e0b"];e.innerHTML=n.slice(0,6).map(([e,t],n)=>{const r=Math.round(t/a*100),s=i[n%i.length];return`\n        <div class="category-item">\n          <div class="category-info">\n            <span class="category-dot" style="background: ${s}"></span>\n            <span class="category-name">${e.replace(/-/g," ")}</span>\n          </div>\n          <div class="category-bar">\n            <div class="category-bar-fill" style="width: ${r}%; background: ${s}"></div>\n          </div>\n          <span class="category-count">${t}</span>\n        </div>\n      `}).join("")}renderBlogHealth(){const e=document.getElementById("health-this-month"),t=document.getElementById("health-avg-words"),n=document.getElementById("health-last-publish"),a=document.getElementById("health-categories");if(!e)return;const i=new Date,r=this.articles.filter(e=>{const t=new Date(e.publishDate);return t.getMonth()===i.getMonth()&&t.getFullYear()===i.getFullYear()}).length;if(e.textContent=r,e.className="health-value "+(r>=4?"good":r>=2?"warning":"danger"),this.articles.length>0){const e=this.articles.reduce((e,t)=>e+(parseInt(t.readTime)||3),0)/this.articles.length;t.textContent=`~${Math.round(200*e)} palabras`}else t.textContent="-";if(this.articles.length>0){const e=[...this.articles].sort((e,t)=>new Date(t.publishDate)-new Date(e.publishDate));n.textContent=this.getRelativeTime(new Date(e[0].publishDate))}else n.textContent="Nunca";const s=new Set(this.articles.map(e=>e.category).filter(Boolean));a.textContent=s.size}filterArticlesTable(e=""){const t=e||document.getElementById("search-articles")?.value||"",n=document.getElementById("filter-category")?.value||"all",a=this.articles.filter(e=>{const a=!t||e.title.toLowerCase().includes(t.toLowerCase())||e.slug.toLowerCase().includes(t.toLowerCase()),i="all"===n||e.category===n;return a&&i}),i=document.getElementById("articles-table-body");if(0===a.length)i.innerHTML='<tr><td colspan="4" class="empty-state">No se encontraron art√≠culos</td></tr>';else{const e=this.articles;this.articles=a,this.renderArticlesTable(),this.articles=e}}editArticle(e){let t=this.articles.find(t=>t.id===e);if(t||(t=this.drafts.find(t=>t.id===e)),!t)return void this.showToast("Art√≠culo no encontrado","error");this.editingArticle=t,this.navigateTo("new-article"),this.populateArticleForm(t),requestAnimationFrame(()=>{this.renderTags(),this.updateSEOScore()});const n="draft"===t.status?"Editar Borrador":"Editar Art√≠culo";document.getElementById("section-title").textContent=n}populateArticleForm(e){document.getElementById("article-id").value=e.id,document.getElementById("article-title").value=e.title,document.getElementById("article-slug").value=e.slug,document.getElementById("article-excerpt").value=e.excerpt,document.getElementById("excerpt-count").textContent=e.excerpt.length,document.getElementById("article-author")&&(document.getElementById("article-author").value=e.author||"Sala Geek");const t=document.querySelector(`input[name="category"][value="${e.category}"]`);if(t&&(t.checked=!0),e.publishDate){const t=new Date(e.publishDate);t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),document.getElementById("article-date").value=t.toISOString().slice(0,16)}if(document.getElementById("article-featured").checked=e.featured||!1,document.getElementById("article-trending").checked=e.trending||!1,document.getElementById("read-time").value=e.readTime||"5 min",document.getElementById("meta-description")){document.getElementById("meta-description").value=e.metaDescription||"";const t=document.getElementById("meta-description-count");t&&(t.textContent=(e.metaDescription||"").length)}document.getElementById("meta-keywords")&&(document.getElementById("meta-keywords").value=e.metaKeywords||""),document.getElementById("canonical-url")&&(document.getElementById("canonical-url").value=e.canonicalUrl||""),document.getElementById("og-image")&&(document.getElementById("og-image").value=e.ogImage||""),document.getElementById("no-index")&&(document.getElementById("no-index").checked=e.noIndex||!1),this.tags=e.tags||[],this.renderTags(),e.image&&(document.getElementById("image-url").value=e.image,document.getElementById("preview-img").src=e.image,document.getElementById("image-preview").classList.remove("hidden"),document.getElementById("upload-placeholder").classList.add("hidden")),this.loadArticleContent(e.content)}async loadArticleContent(e){try{const t=e.endsWith(".html")?e:e+".html",n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.text(),i=new DOMParser,r=i.parseFromString(a,"text/html").querySelector(".article-content");r&&(document.getElementById("article-editor").innerHTML=r.innerHTML,this.clearEditorHistory(),this.saveEditorState(),this.setupEditorImages(),this.updateWordCount(),this.updateSEOScore())}catch(e){console.error("Error loading article content:",e)}}resetArticleForm(){this.editingArticle=null,this.tags=[],localStorage.removeItem("admin_draft_article"),this.clearEditorHistory(),document.getElementById("article-form")?.reset(),document.getElementById("article-id").value="",document.getElementById("article-slug").value="",document.getElementById("excerpt-count").textContent="0",document.getElementById("article-editor").innerHTML="";const e=document.getElementById("article-author");e&&(e.value="Sala Geek"),document.getElementById("image-preview").classList.add("hidden"),document.getElementById("upload-placeholder").classList.remove("hidden"),document.getElementById("preview-img").src="",document.getElementById("image-url").value="";const t=document.getElementById("meta-description");t&&(t.value="");const n=document.getElementById("meta-description-count");n&&(n.textContent="0");const a=document.getElementById("meta-keywords");a&&(a.value="");const i=document.getElementById("canonical-url");i&&(i.value="");const r=document.getElementById("og-image");r&&(r.value="");const s=document.getElementById("no-index");s&&(s.checked=!1),this.renderTags();const o=new Date;o.setMinutes(o.getMinutes()-o.getTimezoneOffset()),document.getElementById("article-date").value=o.toISOString().slice(0,16);const l=document.querySelector('input[name="category"]');l&&(l.checked=!0)}async saveArticle(e=!1){document.getElementById("article-form");const t=e?document.getElementById("btn-draft"):document.getElementById("btn-publish"),n=document.getElementById("article-id").value||this.generateId(),a=document.getElementById("article-title").value.trim()||(e?"Sin t√≠tulo":""),i=document.getElementById("article-slug").value.trim()||this.generateSlug(a||"borrador"),r=document.getElementById("article-excerpt").value.trim(),s=this.getSelectedCategories(),o=this.getPrimaryCategory(),l=e?"draft":"published",d=document.getElementById("article-date").value,c=d?new Date(d).toISOString():(new Date).toISOString(),m=document.getElementById("article-featured").checked,g=document.getElementById("article-trending").checked,h=document.getElementById("read-time").value,u=document.getElementById("image-url").value||document.getElementById("preview-img")?.src||"",p=document.getElementById("article-editor").innerHTML,y=document.getElementById("meta-description")?.value.trim()||"",v=document.getElementById("meta-keywords")?.value.trim()||"",f=document.getElementById("canonical-url")?.value.trim()||"",w=document.getElementById("og-image")?.value.trim()||"",E=document.getElementById("no-index")?.checked||!1,b=e;if(!b){if(!a)return this.showToast("El t√≠tulo es requerido para publicar","error"),void document.getElementById("article-title").focus();if(!r)return this.showToast("El extracto es requerido para publicar","error"),void document.getElementById("article-excerpt").focus();if(!p||""===p.trim()||"<br>"===p)return this.showToast("El contenido del art√≠culo es requerido para publicar","error"),void document.getElementById("article-editor").focus()}if(r.length>CONFIG.MAX_EXCERPT_LENGTH)return void this.showToast(`El extracto es demasiado largo (m√°x ${CONFIG.MAX_EXCERPT_LENGTH} caracteres)`,"warning");const x={id:n,title:a,slug:i,excerpt:r,content:`/blog/articulos/${i}`,image:u,category:o,categories:s,categoryDisplay:{series:"Series",peliculas:"Pel√≠culas",gaming:"Gaming",anime:"Anime",tecnologia:"Tecnolog√≠a"}[o]||o,tags:this.tags,author:document.getElementById("article-author")?.value?.trim()||"Sala Geek",publishDate:c,modifiedDate:(new Date).toISOString(),readTime:h,views:this.editingArticle?.views||0,featured:m,trending:g,status:l,metaDescription:y||r.substring(0,160),metaKeywords:v,canonicalUrl:f,ogImage:w||u,noIndex:E};t.disabled=!0,t.innerHTML='<span class="spinner"></span> Guardando...';try{const e=await this.getAccessToken(),t=await fetch("/api/save-article.php",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},credentials:"include",body:JSON.stringify({article:x,htmlContent:this.generateArticleHTML(x,p),isNew:!this.editingArticle})});if(!t.ok){let e={},n="";try{n=await t.text(),e=JSON.parse(n)}catch(e){console.error("Save error: non-JSON response body:",n)}const a=e.error||`HTTP ${t.status}`,i=e.hint?` (${e.hint})`:"",r=e.file?` [${e.file}:${e.line}]`:"";throw console.error("Save error:",a+i+r,e),new Error(a+i)}await t.json();const n=b?"¬°Borrador guardado exitosamente!":this.editingArticle?"¬°Art√≠culo actualizado exitosamente!":"¬°Art√≠culo publicado exitosamente!";if(this.showToast(n,"success"),this.contentSaved=!0,b){const e=this.drafts.findIndex(e=>e.id===x.id);e>=0?this.drafts[e]=x:this.drafts.unshift(x),this.articles=this.articles.filter(e=>e.id!==x.id)}else{const e=this.articles.findIndex(e=>e.id===x.id);e>=0?this.articles[e]=x:this.articles.unshift(x),this.drafts=this.drafts.filter(e=>e.id!==x.id)}this.updateDashboardStats(),this.renderArticlesTable(),this.renderDraftsTable(),this.renderRecentArticles(),this.renderRecentDrafts(),this.renderActivityLog(),this.renderPublishChart(),this.renderCategoriesBreakdown(),this.renderBlogHealth(),this.updateDraftsCount(),this.editingArticle=null,this.navigateTo(b?"drafts":"articles"),setTimeout(()=>this.loadArticles().catch(()=>{}),8e3)}catch(e){console.error("Error saving article:",e),this.showToast(`Error al guardar: ${e.message}`,"error")}finally{t.disabled=!1;const n=e?"Guardar Borrador":"Publicar",a=e?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n          </svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>\n            <polyline points="17 21 17 13 7 13 7 21"/>\n            <polyline points="7 3 7 8 15 8"/>\n          </svg>';t.innerHTML=`${a} ${n}`}}async deleteArticle(e){let t=this.articles.find(t=>t.id===e);const n=!t;if(t||(t=this.drafts.find(t=>t.id===e)),!t)return void this.showToast("Art√≠culo no encontrado","error");const a=n?"borrador":"art√≠culo";if(await this.showConfirmModal(`¬øEliminar ${a}?`,`"${t.title}" ser√° eliminado permanentemente. Esta acci√≥n no se puede deshacer.`,"Eliminar","danger"))try{const a=await this.getAccessToken(),i=await fetch("/api/save-article.php",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},credentials:"include",body:JSON.stringify({id:e,slug:t.slug,isDraft:n})});if(!i.ok){const e=await i.json().catch(()=>({}));throw new Error(e.error||"Error al eliminar")}const r=n?"Borrador":"Art√≠culo";this.showToast(`${r} "${t.title}" eliminado correctamente`,"success"),n?this.drafts=this.drafts.filter(t=>t.id!==e):this.articles=this.articles.filter(t=>t.id!==e),this.updateDashboardStats(),this.renderArticlesTable(),this.renderDraftsTable(),this.renderRecentArticles(),this.renderRecentDrafts(),this.renderActivityLog(),this.renderPublishChart(),this.renderCategoriesBreakdown(),this.renderBlogHealth(),this.updateDraftsCount(),setTimeout(()=>this.loadArticles().catch(()=>{}),8e3)}catch(e){console.error("Error deleting article:",e),this.showToast(`Error: ${e.message}`,"error")}}async publishDraft(e){const t=this.drafts.find(t=>t.id===e);if(!t)return void this.showToast("Borrador no encontrado","error");if(!t.title||!t.slug||!t.excerpt)return this.showToast("El borrador necesita t√≠tulo, slug y extracto para publicar. Ed√≠talo primero.","warning"),void this.editArticle(e);if(await this.showConfirmModal("¬øPublicar borrador?",`"${t.title}" ser√° publicado y visible para todos los visitantes.`,"Publicar","info"))try{const e=await fetch(`/blog/articulos/${t.slug}.html`);if(!e.ok)throw new Error("No se pudo cargar el contenido del borrador");const n=await e.text(),a=new DOMParser,i=a.parseFromString(n,"text/html").querySelector(".article-content");if(!i)throw new Error("Estructura del art√≠culo inv√°lida");const r={...t,status:"published",publishDate:(new Date).toISOString(),modifiedDate:(new Date).toISOString()},s=await this.getAccessToken(),o=await fetch("/api/save-article.php",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},credentials:"include",body:JSON.stringify({article:r,htmlContent:this.generateArticleHTML(r,i.innerHTML),isNew:!1})});if(!o.ok){const e=await o.json().catch(()=>({}));throw new Error(e.error||"Error al publicar")}this.showToast(`¬°"${t.title}" publicado exitosamente!`,"success"),this.articles.unshift(r),this.drafts=this.drafts.filter(e=>e.id!==r.id),this.updateDashboardStats(),this.renderArticlesTable(),this.renderDraftsTable(),this.renderRecentArticles(),this.renderRecentDrafts(),this.renderActivityLog(),this.renderPublishChart(),this.renderCategoriesBreakdown(),this.renderBlogHealth(),this.updateDraftsCount(),this.navigateTo("articles"),setTimeout(()=>this.loadArticles().catch(()=>{}),8e3)}catch(e){console.error("Error publishing draft:",e),this.showToast(`Error: ${e.message}`,"error")}}showConfirmModal(e,t,n="Confirmar",a="danger"){return new Promise(i=>{const r=document.getElementById("confirm-modal");if(!r)return void i(confirm(t));const s=r.querySelector(".confirm-icon"),o=r.querySelector("h3"),l=r.querySelector("p"),d=document.getElementById("confirm-accept"),c=document.getElementById("confirm-cancel");s.className="confirm-icon"+("danger"!==a?` ${a}`:"");const m=s.querySelector(".icon-danger"),g=s.querySelector(".icon-warning"),h=s.querySelector(".icon-info");m&&(m.style.display="danger"===a?"block":"none"),g&&(g.style.display="warning"===a?"block":"none"),h&&(h.style.display="info"===a?"block":"none"),o.textContent=e,l.textContent=t,d.textContent=n,d.className="danger"===a?"btn-danger":"btn-primary",r.classList.remove("hidden"),setTimeout(()=>c.focus(),100);const u=()=>{r.classList.add("hidden"),d.removeEventListener("click",p),c.removeEventListener("click",y),r.removeEventListener("click",v),document.removeEventListener("keydown",f)},p=()=>{u(),i(!0)},y=()=>{u(),i(!1)},v=e=>{e.target===r&&(u(),i(!1))},f=e=>{if("Escape"===e.key)e.preventDefault(),y();else if("Enter"===e.key&&document.activeElement===d)e.preventDefault(),p();else if("Tab"===e.key){const t=r.querySelectorAll('button:not([disabled]), [tabindex]:not([tabindex="-1"])'),n=t[0],a=t[t.length-1];e.shiftKey?document.activeElement===n&&(e.preventDefault(),a.focus()):document.activeElement===a&&(e.preventDefault(),n.focus())}};d.addEventListener("click",p),c.addEventListener("click",y),r.addEventListener("click",v),document.addEventListener("keydown",f)})}addTag(e){(e=e.trim().toLowerCase())&&!this.tags.includes(e)&&(this.tags.push(e),this.renderTags(),this.updateSEOScore())}removeTag(e){this.tags=this.tags.filter(t=>t!==e),this.renderTags(),this.updateSEOScore()}renderTags(){const e=document.getElementById("tags-list");e&&(e.innerHTML="",this.tags.forEach(t=>{const n=document.createElement("span");n.className="tag-item",n.textContent=t;const a=document.createElement("button");a.type="button",a.innerHTML="&times;",a.title="Eliminar tag",a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.removeTag(t)}),n.appendChild(a),e.appendChild(n)}))}showPreview(){const e=document.getElementById("article-title").value||"Sin t√≠tulo",t=document.getElementById("article-excerpt").value||"",n=document.getElementById("article-editor").innerHTML,a=this.getPrimaryCategory(),i=document.getElementById("image-url").value||document.getElementById("preview-img")?.src,r=this.tags||[],s=this.generateArticlePreviewHTML(e,t,n,a,i,r);document.getElementById("preview-frame").srcdoc=s,document.getElementById("preview-modal").classList.remove("hidden"),this.setPreviewDevice("desktop")}generateArticlePreviewHTML(e,t,n,a,i,r=[]){const s=window.location.origin,o=a.charAt(0).toUpperCase()+a.slice(1),l=(new Date).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"}),d=document.getElementById("article-reading-time")?.value||"5";return`\n      <!DOCTYPE html>\n      <html lang="es">\n      <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <base href="${s}/">\n        <title>${this.escapeHtml(e)} | Sala Geek</title>\n        <link rel="stylesheet" href="${s}/src/css/normalize.css">\n        <link rel="stylesheet" href="${s}/src/css/style.min.css">\n        <link rel="stylesheet" href="${s}/src/css/blog.css">\n        <style>\n          /* Variables del sitio */\n          :root {\n            --bg-primary: #0a0e27;\n            --bg-secondary: #0f1433;\n            --text-primary: #e4e6eb;\n            --text-secondary: #8b8fa3;\n            --text-tertiary: #6c7086;\n            --accent-primary: #ffd166;\n            --accent-secondary: #ff9f1c;\n            --border-color: rgba(255, 209, 102, 0.1);\n          }\n          \n          body { \n            background: var(--bg-primary); \n            color: var(--text-primary);\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            line-height: 1.6;\n          }\n          \n          .preview-wrapper {\n            max-width: 900px;\n            margin: 0 auto;\n            padding: 2rem;\n          }\n          \n          /* Breadcrumbs */\n          .breadcrumbs {\n            background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(10, 14, 39, 0.7) 100%);\n            border-bottom: 1px solid rgba(255, 209, 102, 0.08);\n            padding: 0.875rem 2rem;\n            margin: -2rem -2rem 2rem -2rem;\n          }\n          .breadcrumbs ol {\n            display: flex;\n            align-items: center;\n            gap: 0.25rem;\n            list-style: none;\n            margin: 0;\n            padding: 0;\n            font-size: 0.85rem;\n          }\n          .breadcrumbs li {\n            display: flex;\n            align-items: center;\n            gap: 0.5rem;\n            color: var(--text-secondary);\n          }\n          .breadcrumbs li a {\n            color: var(--text-secondary);\n            text-decoration: none;\n          }\n          .breadcrumbs li:not(:last-child)::after {\n            content: "‚Ä∫";\n            margin-left: 0.6rem;\n            color: var(--accent-primary);\n            font-weight: 600;\n          }\n          .breadcrumbs li.active {\n            color: var(--accent-primary);\n            font-weight: 500;\n          }\n          \n          /* Article header */\n          .article-full { max-width: 800px; margin: 0 auto; }\n          .article-header { margin-bottom: 2rem; }\n          \n          .article-meta-top { \n            display: flex; \n            flex-wrap: wrap;\n            align-items: center; \n            gap: 0.75rem 1rem; \n            margin-bottom: 1rem;\n          }\n          \n          .article-category { \n            display: inline-flex;\n            align-items: center;\n            gap: 0.5rem;\n            padding: 0.625rem 1.25rem;\n            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);\n            color: var(--bg-primary);\n            font-size: 0.8rem;\n            font-weight: 700;\n            text-transform: uppercase;\n            letter-spacing: 0.75px;\n            border-radius: 50px;\n            text-decoration: none;\n            box-shadow: 0 4px 15px rgba(255, 209, 102, 0.25);\n          }\n          .article-category svg { width: 16px; height: 16px; }\n          \n          time {\n            display: flex;\n            align-items: center;\n            gap: 0.4rem;\n            color: var(--text-tertiary);\n            font-size: 0.9rem;\n          }\n          time svg { width: 14px; height: 14px; opacity: 0.7; }\n          \n          .article-title { \n            font-size: 2.25rem; \n            font-weight: 800;\n            margin: 1rem 0 1.25rem;\n            line-height: 1.25;\n            color: var(--text-primary);\n            letter-spacing: -0.02em;\n          }\n          \n          .article-excerpt { \n            color: var(--text-secondary);\n            font-size: 1.125rem;\n            line-height: 1.7;\n            margin-bottom: 1.5rem;\n          }\n          \n          .article-meta-bottom {\n            display: flex;\n            gap: 1.5rem;\n            padding: 1rem 0;\n            border-top: 1px solid var(--border-color);\n            border-bottom: 1px solid var(--border-color);\n            margin-bottom: 2rem;\n          }\n          .article-meta-bottom span {\n            display: flex;\n            align-items: center;\n            gap: 0.4rem;\n            font-size: 0.875rem;\n            color: var(--text-tertiary);\n          }\n          .article-meta-bottom svg { width: 16px; height: 16px; opacity: 0.7; }\n          \n          /* Featured image */\n          .article-featured-image { \n            margin: 0 0 2rem;\n            border-radius: 12px;\n            overflow: hidden;\n            background: var(--bg-secondary);\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n          }\n          .article-featured-image img { \n            width: 100%; \n            display: block;\n            aspect-ratio: 16/9;\n            object-fit: cover;\n          }\n          .article-featured-image figcaption {\n            background: var(--bg-secondary);\n            padding: 0.75rem 1rem;\n            font-size: 0.85rem;\n            color: var(--text-tertiary);\n            font-style: italic;\n            text-align: center;\n          }\n          \n          /* Article content */\n          .article-content { \n            font-size: 1.0625rem;\n            line-height: 1.8;\n            color: var(--text-primary);\n          }\n          .article-content .lead {\n            font-size: 1.25rem;\n            line-height: 1.75;\n            margin-bottom: 2rem;\n            padding-bottom: 2rem;\n            border-bottom: 1px solid var(--border-color);\n          }\n          .article-content p { margin-bottom: 1.5rem; }\n          .article-content strong { color: var(--accent-primary); font-weight: 600; }\n          \n          .article-content h2 { \n            font-size: 1.75rem;\n            font-weight: 700;\n            margin: 3rem 0 1.25rem;\n            padding: 1rem 0 1rem 1.25rem;\n            position: relative;\n            border-left: 3px solid var(--accent-primary);\n            background: linear-gradient(90deg, rgba(255, 209, 102, 0.08) 0%, transparent 50%);\n            border-radius: 0 8px 8px 0;\n          }\n          \n          .article-content h3 { \n            font-size: 1.375rem;\n            font-weight: 600;\n            margin: 2rem 0 1rem;\n            padding-left: 0.75rem;\n            border-left: 2px solid rgba(255, 209, 102, 0.4);\n          }\n          \n          .article-content ul, .article-content ol {\n            margin: 1.5rem 0;\n            padding-left: 0;\n            list-style: none;\n          }\n          .article-content li {\n            position: relative;\n            padding-left: 1.75rem;\n            margin-bottom: 0.75rem;\n          }\n          .article-content ul li::before {\n            content: '';\n            position: absolute;\n            left: 0;\n            top: 0.6em;\n            width: 8px;\n            height: 8px;\n            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));\n            border-radius: 50%;\n          }\n          \n          .article-content blockquote { \n            margin: 2rem 0;\n            padding: 1.5rem 2rem;\n            background: linear-gradient(135deg, rgba(255, 209, 102, 0.05) 0%, rgba(255, 159, 28, 0.08) 100%);\n            border-left: 4px solid var(--accent-primary);\n            border-radius: 0 12px 12px 0;\n            font-style: italic;\n          }\n          .article-content blockquote p { margin-bottom: 0.75rem; font-size: 1.125rem; }\n          .article-content blockquote p:last-child { margin-bottom: 0; }\n          \n          .article-content a {\n            color: var(--accent-primary);\n            text-decoration: underline;\n            text-underline-offset: 3px;\n          }\n          \n          .article-content img { \n            max-width: 100%; \n            border-radius: 8px;\n            margin: 1rem 0;\n          }\n          \n          /* Resizable images */\n          .resizable-image, .resizable-image img { max-width: 100%; }\n          .resizable-image.float-left { float: left; margin: 0 1.5rem 1rem 0; }\n          .resizable-image.float-right { float: right; margin: 0 0 1rem 1.5rem; }\n          .resizable-image.align-left { \n            display: block; \n            margin: 1.5rem auto 1.5rem 0;\n            width: fit-content;\n          }\n          .resizable-image.align-center { \n            display: block; \n            margin: 1.5rem auto; \n            text-align: center;\n            width: fit-content;\n          }\n          .resizable-image.align-right { \n            display: block; \n            margin: 1.5rem 0 1.5rem auto;\n            width: fit-content;\n          }\n          \n          /* Figure alignment */\n          figure.align-left {\n            display: block;\n            margin: 1.5rem auto 1.5rem 0;\n            width: fit-content;\n          }\n          figure.align-center {\n            display: block;\n            margin: 1.5rem auto;\n            width: fit-content;\n          }\n          figure.align-right {\n            display: block;\n            margin: 1.5rem 0 1.5rem auto;\n            width: fit-content;\n          }\n          \n          /* Image grids */\n          .image-grid-container { display: grid; gap: 0.75rem; margin: 1.5rem 0; }\n          .image-grid-container.cols-2 { grid-template-columns: repeat(2, 1fr); }\n          .image-grid-container.cols-3 { grid-template-columns: repeat(3, 1fr); }\n          .image-grid-container.cols-4 { grid-template-columns: repeat(4, 1fr); }\n          .image-grid-container img { width: 100%; height: auto; object-fit: cover; border-radius: 8px; }\n          \n          /* Figure and figcaption */\n          figure.resizable-image {\n            display: block;\n          }\n          figure.resizable-image img {\n            display: block;\n            width: 100%;\n          }\n          figcaption { \n            display: block;\n            text-align: center; \n            font-size: 0.85rem; \n            color: var(--text-tertiary); \n            margin-top: 0.5rem; \n            font-style: italic; \n          }\n          \n          /* Video containers */\n          .video-container, .youtube-embed {\n            position: relative;\n            width: 100%;\n            padding-bottom: 56.25%;\n            margin: 2rem auto;\n            background: var(--bg-secondary);\n            border-radius: 12px;\n            overflow: hidden;\n          }\n          .video-container.video-small, .youtube-embed.video-small { max-width: 400px; }\n          .video-container.video-medium, .youtube-embed.video-medium { max-width: 560px; }\n          .video-container.video-large, .youtube-embed.video-large { max-width: 750px; }\n          .video-container.video-full, .youtube-embed.video-full { max-width: 100%; }\n          .video-container iframe, .youtube-embed iframe {\n            position: absolute;\n            top: 0; left: 0;\n            width: 100%; height: 100%;\n            border: none;\n          }\n          \n          /* Preview badge */\n          .preview-badge {\n            position: fixed;\n            top: 0.5rem;\n            left: 50%;\n            transform: translateX(-50%);\n            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));\n            color: #0a0e27;\n            padding: 0.35rem 0.75rem;\n            border-radius: 2rem;\n            font-size: 0.65rem;\n            font-weight: 700;\n            text-transform: uppercase;\n            letter-spacing: 0.05em;\n            box-shadow: 0 4px 15px rgba(255, 209, 102, 0.3);\n            z-index: 100;\n            white-space: nowrap;\n          }\n          \n          /* Responsive para m√≥vil */\n          @media (max-width: 500px) {\n            .preview-wrapper {\n              padding: 1rem;\n              padding-top: 2.5rem;\n            }\n            .breadcrumbs {\n              padding: 0.5rem 1rem;\n              margin: -1rem -1rem 1rem -1rem;\n              font-size: 0.75rem;\n              overflow-x: auto;\n              white-space: nowrap;\n            }\n            .breadcrumbs ol {\n              flex-wrap: nowrap;\n            }\n            .article-meta-top {\n              flex-direction: column;\n              align-items: flex-start;\n              gap: 0.5rem;\n            }\n            .article-title {\n              font-size: 1.5rem;\n            }\n            .article-excerpt {\n              font-size: 1rem;\n            }\n            .article-category {\n              padding: 0.5rem 1rem;\n              font-size: 0.7rem;\n            }\n            .article-meta-bottom {\n              flex-direction: column;\n              gap: 0.75rem;\n            }\n          }\n        </style>\n      </head>\n      <body class="article-page">\n        <div class="preview-badge">Vista Previa</div>\n        \n        <div class="preview-wrapper">\n          <nav class="breadcrumbs">\n            <ol>\n              <li><a href="#">Inicio</a></li>\n              <li><a href="#">Blog</a></li>\n              <li><a href="#">${o}</a></li>\n              <li class="active">${this.escapeHtml(e).substring(0,30)}${e.length>30?"...":""}</li>\n            </ol>\n          </nav>\n          \n          <article class="article-full">\n            <header class="article-header">\n              <div class="article-meta-top">\n                <a class="article-category category-${a}">\n                  ${this.getCategoryIconForPreview(a)}\n                  ${o}\n                </a>\n                <time>\n                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>\n                  ${l}\n                </time>\n              </div>\n              \n              <h1 class="article-title">${this.escapeHtml(e)}</h1>\n              <p class="article-excerpt">${this.escapeHtml(t)}</p>\n              \n              <div class="article-meta-bottom">\n                <span>\n                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                    <circle cx="12" cy="12" r="10"></circle>\n                    <polyline points="12 6 12 12 16 14"></polyline>\n                  </svg>\n                  ${d} min de lectura\n                </span>\n                <span>\n                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n                    <circle cx="12" cy="12" r="3"></circle>\n                  </svg>\n                  0 vistas\n                </span>\n              </div>\n            </header>\n            \n            ${i&&""!==i&&!i.includes("data:,")?`\n            <figure class="article-featured-image">\n              <img src="${i}" alt="${this.escapeHtml(e)}" onerror="this.parentElement.style.display='none'">\n            </figure>\n            `:""}\n            \n            <div class="article-content">${n}</div>\n\n            ${r.length>0?`\n            <section class="article-tags">\n              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>\n              <h4>Tags</h4>\n              ${r.map(e=>`<a class="article-tag">${this.escapeHtml(e)}</a>`).join("")}\n            </section>\n            `:""}\n          </article>\n        </div>\n      </body>\n      </html>\n    `}getCategoryIconForPreview(e){const t={series:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>',peliculas:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg>',gaming:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="12" x2="6.01" y2="12"/><line x1="10" y1="12" x2="18" y2="12"/></svg>',anime:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8 2 4 6 4 10c0 2.5 1 4.5 2.5 6l-1 4 3-2c1 .6 2.2 1 3.5 1s2.5-.4 3.5-1l3 2-1-4c1.5-1.5 2.5-3.5 2.5-6 0-4-4-8-8-8z"></path></svg>',tecnologia:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>'};return t[e]||t.series}sanitizeHTML(e){const t=document.createElement("div");t.innerHTML=e;return["script","object","embed","form","input","textarea","select","button","link","meta","style","applet","base","basefont"].forEach(e=>{t.querySelectorAll(e).forEach(e=>e.remove())}),t.querySelectorAll("iframe").forEach(e=>{const t=(e.getAttribute("src")||"").toLowerCase().replace(/\s/g,"");t.startsWith("https://www.youtube.com/embed/")||t.startsWith("https://youtube.com/embed/")||t.startsWith("https://www.youtube-nocookie.com/embed/")||e.remove()}),t.querySelectorAll("*").forEach(e=>{const t=[];for(const n of e.attributes){const e=n.name.toLowerCase();e.startsWith("on")&&t.push(n.name),"href"!==e&&"src"!==e&&"action"!==e||!n.value.replace(/\s/g,"").toLowerCase().startsWith("javascript:")||t.push(n.name),"src"===e&&n.value.replace(/\s/g,"").toLowerCase().startsWith("data:")&&!n.value.replace(/\s/g,"").toLowerCase().startsWith("data:image/")&&t.push(n.name)}t.forEach(t=>e.removeAttribute(t))}),t.querySelectorAll("img").forEach(e=>{e.hasAttribute("loading")||e.setAttribute("loading","lazy")}),t.innerHTML}generateArticleHTML(e,t){t=this.sanitizeHTML(t);const n=document.createElement("div");n.innerHTML=t,n.querySelectorAll(".image-toolbar").forEach(e=>e.remove()),n.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected")),n.querySelectorAll(".video-container, .youtube-embed").forEach(e=>{if(!e.querySelector("iframe"))return void e.remove();const t=e.querySelector(".video-toolbar");t&&t.remove(),e.style.outline="",e.style.outlineOffset=""}),n.querySelectorAll(".image-resize-wrapper").forEach(e=>{e.querySelectorAll(".resize-handle").forEach(e=>e.remove()),e.classList.remove("has-selected")}),t=n.innerHTML;const a={series:'<rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline>',peliculas:'<rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/>',gaming:'<rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="12" x2="6.01" y2="12"/><line x1="10" y1="12" x2="18" y2="12"/>',anime:'<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',tecnologia:'<rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>'},i=document.createElement("div");i.innerHTML=t;const r=(i.textContent||"").trim().split(/\s+/).filter(e=>e.length>0).length,s=e.image?`\n      <figure class="article-featured-image">\n        <img \n          src="${e.image}" \n          alt="${this.escapeHtml(e.title)}"\n          loading="eager"\n          width="1200"\n          height="630"\n        />\n      </figure>`:"";return`<!doctype html>\n<html lang="es">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1" />\n  <meta name="google-adsense-account" content="ca-pub-3884162231581435" />\n  \n  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3884162231581435" crossorigin="anonymous"><\/script>\n  \n  <title>${this.escapeHtml(e.title)} | Sala Geek</title>\n  <meta name="description" content="${this.escapeHtml(e.metaDescription||e.excerpt)}" />\n  <meta name="keywords" content="${this.escapeHtml(e.metaKeywords||(e.tags||[]).join(", "))}" />\n  <meta name="author" content="${this.escapeHtml(e.author||"Sala Geek")}" />\n  <meta name="robots" content="${e.noIndex?"noindex, nofollow":"index, follow, max-image-preview:large"}" />\n  <link rel="canonical" href="${this.escapeHtml(e.canonicalUrl||`https://salageek.com/blog/articulos/${e.slug}`)}" />\n  \n  <meta name="article:published_time" content="${e.publishDate}" />\n  <meta name="article:modified_time" content="${e.modifiedDate}" />\n  <meta name="article:section" content="${e.categoryDisplay}" />\n\n  <meta property="og:type" content="article" />\n  <meta property="og:title" content="${this.escapeHtml(e.title)}" />\n  <meta property="og:description" content="${this.escapeHtml(e.metaDescription||e.excerpt)}" />\n  <meta property="og:image" content="${e.ogImage||e.image}" />\n  <meta property="og:url" content="https://salageek.com/blog/articulos/${e.slug}" />\n\n  <meta name="twitter:card" content="summary_large_image" />\n  <meta name="twitter:title" content="${this.escapeHtml(e.title)}" />\n  <meta name="twitter:description" content="${this.escapeHtml(e.excerpt)}" />\n  <meta name="twitter:image" content="${e.ogImage||e.image}" />\n\n  <link rel="icon" href="/src/images/Icono_SG.ico" type="image/x-icon" />\n  <link rel="apple-touch-icon" href="/src/images/SalaGeek_LOGO.webp" />\n  <meta name="theme-color" content="#1a1f3a" />\n\n  <script type="application/ld+json">\n  {\n    "@context": "https://schema.org",\n    "@type": "Article",\n    "headline": "${this.escapeHtml(e.title)}",\n    "description": "${this.escapeHtml(e.metaDescription||e.excerpt)}",\n    "image": {\n      "@type": "ImageObject",\n      "url": "${e.ogImage||e.image}",\n      "width": 1200,\n      "height": 630\n    },\n    "author": {\n      "@type": "Organization",\n      "name": "Sala Geek",\n      "url": "https://salageek.com",\n      "logo": {\n        "@type": "ImageObject",\n        "url": "https://salageek.com/src/images/SalaGeek_LOGO.webp"\n      }\n    },\n    "publisher": {\n      "@type": "Organization",\n      "name": "Sala Geek",\n      "logo": {\n        "@type": "ImageObject",\n        "url": "https://salageek.com/src/images/SalaGeek_LOGO.webp",\n        "width": 512,\n        "height": 512\n      }\n    },\n    "datePublished": "${e.publishDate}",\n    "dateModified": "${e.modifiedDate}",\n    "mainEntityOfPage": {\n      "@type": "WebPage",\n      "@id": "https://salageek.com/blog/articulos/${e.slug}"\n    },\n    "articleSection": "${this.escapeHtml(e.categoryDisplay)}",\n    "keywords": "${this.escapeHtml(e.metaKeywords||(e.tags||[]).join(", "))}",\n    "wordCount": "${r}",\n    "inLanguage": "es"\n  }\n  <\/script>\n\n  <script type="application/ld+json">\n  {\n    "@context": "https://schema.org",\n    "@type": "BreadcrumbList",\n    "itemListElement": [\n      {"@type": "ListItem", "position": 1, "name": "Inicio", "item": "https://salageek.com"},\n      {"@type": "ListItem", "position": 2, "name": "Blog", "item": "https://salageek.com/blog"},\n      {"@type": "ListItem", "position": 3, "name": "${e.categoryDisplay}", "item": "https://salageek.com/blog/?categoria=${e.category}"},\n      {"@type": "ListItem", "position": 4, "name": "${this.escapeHtml(e.title.substring(0,50))}"}\n    ]\n  }\n  <\/script>\n\n  <link rel="stylesheet" href="/src/css/normalize.css" />\n  <link rel="stylesheet" href="/src/css/style.min.css?v=300" />\n  <link rel="stylesheet" href="/src/css/blog.min.css?v=300" />\n  \n  <script src="/src/js/blog-engine.min.js?v=300" defer><\/script>\n</head>\n\n<body class="article-page">\n  <div id="header-container"></div>\n\n  <main class="blog-article-page">\n    <nav class="breadcrumbs" aria-label="Breadcrumb">\n      <ol>\n        <li>\n          <a href="/">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14">\n              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>\n              <polyline points="9 22 9 12 15 12 15 22"></polyline>\n            </svg>\n            Inicio\n          </a>\n        </li>\n        <li>\n          <a href="/blog/">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14">\n              <rect x="2" y="3" width="20" height="14" rx="2"></rect>\n              <line x1="8" y1="21" x2="16" y2="21"></line>\n              <line x1="12" y1="17" x2="12" y2="21"></line>\n            </svg>\n            Blog\n          </a>\n        </li>\n        <li>\n          <a href="/blog/?categoria=${e.category}">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">${a[e.category]||""}</svg>\n            ${e.categoryDisplay}\n          </a>\n        </li>\n        <li aria-current="page">${this.escapeHtml(e.title.substring(0,40))}${e.title.length>40?"...":""}</li>\n      </ol>\n    </nav>\n\n    <article class="article-full">\n      <header class="article-header">\n        <div class="article-meta-top">\n          <a href="/blog/?categoria=${e.category}" class="article-category category-${e.category}">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${a[e.category]||""}</svg>\n            ${e.categoryDisplay}\n          </a>\n          <time datetime="${e.publishDate.split("T")[0]}">\n            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>\n            ${o=e.publishDate,new Date(o).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})}\n          </time>\n        </div>\n\n        <h1 class="article-title">${this.escapeHtml(e.title)}</h1>\n\n        <p class="article-excerpt">${this.escapeHtml(e.excerpt)}</p>\n\n        <div class="article-meta-bottom">\n          <span class="article-author">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n              <circle cx="12" cy="7" r="4"></circle>\n            </svg>\n            Por ${this.escapeHtml(e.author||"Sala Geek")}\n          </span>\n          <span>\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <circle cx="12" cy="12" r="10"></circle>\n              <polyline points="12 6 12 12 16 14"></polyline>\n            </svg>\n            ${e.readTime} de lectura\n          </span>\n          <span>\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n              <circle cx="12" cy="12" r="3"></circle>\n            </svg>\n            <span id="view-count">${e.views||0}</span> vistas\n          </span>\n        </div>\n      </header>\n\n      ${s}\n\n      <div class="article-content">\n        ${t}\n      </div>\n\n      \x3c!-- Share buttons --\x3e\n      <aside class="article-share">\n        <h3>\n          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <circle cx="18" cy="5" r="3"></circle>\n            <circle cx="6" cy="12" r="3"></circle>\n            <circle cx="18" cy="19" r="3"></circle>\n            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>\n            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>\n          </svg>\n          Compartir art√≠culo\n        </h3>\n        <div class="share-buttons">\n          <button class="share-btn share-twitter" onclick="shareOnTwitter()" aria-label="Compartir en Twitter">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>\n            <span>Twitter</span>\n          </button>\n          <button class="share-btn share-facebook" onclick="shareOnFacebook()" aria-label="Compartir en Facebook">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>\n            <span>Facebook</span>\n          </button>\n          <button class="share-btn share-whatsapp" onclick="shareOnWhatsApp()" aria-label="Compartir en WhatsApp">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n            <span>WhatsApp</span>\n          </button>\n          <button class="share-btn share-copy" onclick="copyLink(this)" aria-label="Copiar enlace">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>\n              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>\n            </svg>\n            <span>Copiar</span>\n          </button>\n        </div>\n      </aside>\n\n      \x3c!-- Tags --\x3e\n      <div class="article-tags">\n        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>\n          <line x1="7" y1="7" x2="7.01" y2="7"></line>\n        </svg>\n        ${(e.tags||[]).map(e=>`<a href="/blog/?tag=${encodeURIComponent(e)}" class="article-tag">${e}</a>`).join("\n        ")}\n      </div>\n\n      \x3c!-- Related articles --\x3e\n      <section class="related-articles">\n        <h2 class="related-title">\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n            <circle cx="12" cy="12" r="3"></circle>\n          </svg>\n          Tambi√©n te puede interesar\n        </h2>\n        <div class="related-grid" id="related-articles">\n          <div class="loading-spinner">\n            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>\n            </svg>\n          </div>\n        </div>\n      </section>\n\n      \x3c!-- Comments with Giscus --\x3e\n      <section class="comments-section">\n        <h2 class="comments-title">\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>\n          </svg>\n          Comentarios\n        </h2>\n        <div class="giscus-container">\n          <script src="https://giscus.app/client.js"\n            data-repo="HumbertMarin09/SalaGeek_Landing"\n            data-repo-id="R_kgDOQN3OMw"\n            data-category="Announcements"\n            data-category-id="DIC_kwDOQN3OM84C1Dzm"\n            data-mapping="pathname"\n            data-strict="0"\n            data-reactions-enabled="1"\n            data-emit-metadata="0"\n            data-input-position="top"\n            data-theme="dark"\n            data-lang="es"\n            data-loading="lazy"\n            crossorigin="anonymous"\n            async>\n          <\/script>\n        </div>\n      </section>\n    </article>\n  </main>\n\n  <div id="footer-container"></div>\n\n  <script src="/src/js/script.min.js?v=300" defer><\/script>\n  \n  \x3c!-- Share functions --\x3e\n  <script>\n    function shareOnTwitter() {\n      const url = encodeURIComponent(window.location.href);\n      const text = encodeURIComponent(document.title);\n      window.open('https://twitter.com/intent/tweet?url=' + url + '&text=' + text, '_blank', 'width=550,height=420');\n    }\n    function shareOnFacebook() {\n      const url = encodeURIComponent(window.location.href);\n      window.open('https://www.facebook.com/sharer/sharer.php?u=' + url, '_blank', 'width=550,height=420');\n    }\n    function shareOnWhatsApp() {\n      const url = encodeURIComponent(window.location.href);\n      const text = encodeURIComponent(document.title);\n      window.open('https://wa.me/?text=' + text + '%20' + url, '_blank');\n    }\n    function copyLink(btn) {\n      navigator.clipboard.writeText(window.location.href).then(function() {\n        btn.classList.add('copied');\n        var span = btn.querySelector('span');\n        var orig = span.textContent;\n        span.textContent = '¬°Copiado!';\n        btn.querySelector('svg').innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';\n        setTimeout(function() {\n          btn.classList.remove('copied');\n          span.textContent = orig;\n          btn.querySelector('svg').innerHTML = '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>';\n        }, 2000);\n      });\n    }\n  <\/script>\n\n  \x3c!-- Load header, footer and related articles --\x3e\n  <script>\n    // Load header and footer partials\n    fetch('/src/pages/partials/header.html')\n      .then(function(r) { return r.text(); })\n      .then(function(html) { document.getElementById('header-container').innerHTML = html; });\n    fetch('/src/pages/partials/footer.html')\n      .then(function(r) { return r.text(); })\n      .then(function(html) { document.getElementById('footer-container').innerHTML = html; });\n\n    // Track article view\n    (function() {\n      var slug = window.location.pathname.split('/').pop().replace('.html', '');\n      if (slug) {\n        fetch('/api/track-view.php', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ slug: slug })\n        })\n        .then(function(r) { return r.json(); })\n        .then(function(data) {\n          var el = document.getElementById('view-count');\n          if (el && data.views !== undefined) {\n            el.textContent = data.views;\n          }\n        })\n        .catch(function() {});\n      }\n    })();\n\n    // Load related articles\n    document.addEventListener('DOMContentLoaded', async function() {\n      const blogEngine = new BlogEngine();\n      await blogEngine.init();\n      \n      const currentSlug = window.location.pathname.split('/').pop().replace('.html', '');\n      const currentArticle = blogEngine.articles.find(function(a) { return a.slug === currentSlug; });\n      \n      if (currentArticle) {\n        const related = blogEngine.getRelatedArticles(currentArticle.id, 3);\n        const relatedContainer = document.getElementById('related-articles');\n        \n        if (related.length > 0 && relatedContainer) {\n          relatedContainer.innerHTML = related.map(function(article) {\n            return '<article class="related-card">' +\n              '<a href="' + article.content + '" class="related-card-link">' +\n                '<div class="related-card-image">' +\n                  '<img src="' + article.image + '" alt="' + article.title + '" loading="lazy" />' +\n                  '<span class="related-card-category category-' + article.category + '">' + article.categoryDisplay + '</span>' +\n                '</div>' +\n                '<div class="related-card-content">' +\n                  '<h4 class="related-card-title">' + article.title + '</h4>' +\n                  '<p class="related-card-excerpt">' + (article.excerpt || '') + '</p>' +\n                  '<div class="related-card-meta">' +\n                    '<span class="related-card-date">' +\n                      '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +\n                      blogEngine.formatDate(article.publishDate) +\n                    '</span>' +\n                    '<span class="related-card-arrow">' +\n                      'Leer' +\n                      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>' +\n                    '</span>' +\n                  '</div>' +\n                '</div>' +\n              '</a>' +\n            '</article>';\n          }).join('');\n        } else if (relatedContainer) {\n          relatedContainer.innerHTML = '<p class="no-related">No hay art√≠culos relacionados disponibles.</p>';\n        }\n      }\n    });\n  <\/script>\n</body>\n</html>`;var o}generateId(){return Date.now().toString(36)+crypto.getRandomValues(new Uint32Array(1))[0].toString(36)}updateWordCount(){const e=document.getElementById("article-editor"),t=document.getElementById("word-count");if(!e||!t)return;const n=(e.innerText||"").trim().split(/\s+/).filter(e=>e.length>0);t.textContent=n.length}generateSlug(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/√±/g,"n").replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/(^-|-$)/g,"").substring(0,60)}estimateReadTime(e){const t=e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim().split(" ").filter(e=>e.length>0).length;return`${Math.max(1,Math.ceil(t/200))} min`}formatDate(e){return new Date(e).toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showToast(e,t="info"){const n=document.getElementById("toast-container"),a=document.createElement("div");a.className=`toast ${t}`,a.innerHTML=`\n      <span class="toast-icon">${{success:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',error:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',info:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'}[t]}</span>\n      <span class="toast-message">${e}</span>\n      <button class="toast-close" onclick="this.parentElement.remove()">\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <line x1="18" y1="6" x2="6" y2="18"/>\n          <line x1="6" y1="6" x2="18" y2="18"/>\n        </svg>\n      </button>\n    `,n.appendChild(a),setTimeout(()=>{a.style.animation="slideIn 0.3s ease reverse",setTimeout(()=>a.remove(),300)},CONFIG.TOAST_DURATION)}setupSEOPreview(){const e=document.getElementById("article-title"),t=document.getElementById("article-slug"),n=document.getElementById("meta-description"),a=document.getElementById("article-excerpt"),i=()=>{const i=e?.value?.trim()||"T√≠tulo del art√≠culo",r=t?.value?.trim()||this.generateSlug(i),s=n?.value?.trim()||a?.value?.trim()||"La meta descripci√≥n aparecer√° aqu√≠. Escribe una descripci√≥n atractiva de 150-160 caracteres...",o=document.getElementById("seo-preview-title"),l=document.getElementById("seo-preview-url"),d=document.getElementById("seo-preview-desc");o&&(o.textContent=`${i} | Sala Geek`),l&&(l.textContent=`salageek.com ‚Ä∫ blog ‚Ä∫ ${r||"articulos"}`),d&&(d.textContent=s),this.updateSEOScore()};e?.addEventListener("input",i),t?.addEventListener("input",i),n?.addEventListener("input",i),a?.addEventListener("input",i),document.getElementById("article-editor")?.addEventListener("input",()=>this.updateSEOScore()),document.getElementById("image-url")?.addEventListener("change",()=>this.updateSEOScore()),document.getElementById("tags-input")?.addEventListener("keydown",()=>setTimeout(()=>this.updateSEOScore(),100)),i()}calculateSEOScore(){const e={title:!1,description:!1,excerpt:!1,image:!1,content:!1,tags:!1},t=(document.getElementById("article-title")?.value?.trim()||"").length;t>=30&&t<=70?e.title=t>=50&&t<=60?"pass":"warn":t>0&&(e.title="fail");const n=document.getElementById("meta-description")?.value?.trim()||"",a=document.getElementById("article-excerpt")?.value?.trim()||"",i=n.length||a.length;i>=120&&i<=160?e.description=i>=150?"pass":"warn":i>0&&(e.description=i<120?"warn":"fail"),a.length>=50?e.excerpt="pass":a.length>0&&(e.excerpt="warn");const r=document.getElementById("image-url")?.value?.trim()||"",s=document.getElementById("preview-img"),o=s?.getAttribute("src")||"";(r&&(r.startsWith("http")||r.startsWith("data:image/")||r.startsWith("/"))||o&&(o.startsWith("http")||o.startsWith("data:image/")||o.startsWith("/"))&&o.length>10)&&(e.image="pass");const l=(document.getElementById("article-editor")?.innerText||"").trim().split(/\s+/).filter(e=>e.length>0).length;l>=300?e.content="pass":l>=150?e.content="warn":l>0&&(e.content="fail");const d=this.tags?.length||0;d>=2?e.tags="pass":d>0&&(e.tags="warn");let c=0,m=0;return Object.values(e).forEach(e=>{m++,"pass"===e&&c++}),{checks:e,passed:c,total:m,percentage:Math.round(c/m*100)}}renderSEOScore({checks:e,passed:t,total:n,percentage:a}){const i=document.getElementById("seo-score-circle"),r=document.getElementById("seo-score-value"),s=document.getElementById("seo-score-label");i&&r&&s&&(r.textContent=`${t}/${n}`,i.classList.remove("score-bad","score-medium","score-good"),s.classList.remove("score-bad","score-medium","score-good"),a>=80?(i.classList.add("score-good"),s.classList.add("score-good"),s.textContent="Excelente"):a>=50?(i.classList.add("score-medium"),s.classList.add("score-medium"),s.textContent="Mejorable"):(i.classList.add("score-bad"),s.classList.add("score-bad"),s.textContent="Necesita trabajo")),Object.entries(e).forEach(([e,t])=>{const n=document.querySelector(`.seo-check[data-check="${e}"]`);if(n){n.classList.remove("check-pass","check-fail","check-warn");const e=n.querySelector(".seo-check-icon");"pass"===t?(n.classList.add("check-pass"),e&&(e.textContent="")):"warn"===t?(n.classList.add("check-warn"),e&&(e.textContent="")):"fail"===t?(n.classList.add("check-fail"),e&&(e.textContent="")):e&&(e.textContent="‚óã")}})}updateSEOScore(){const e=this.calculateSEOScore();this.renderSEOScore(e)}setupCollapsibleSections(){document.querySelectorAll(".collapsible-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".sidebar-card-collapsible");t?.classList.toggle("collapsed")})})}setupCategoryMultiSelect(){const e=document.getElementById("add-subcategory-btn"),t=document.getElementById("new-subcategory-input"),n=document.getElementById("new-subcategory-name"),a=document.getElementById("confirm-new-subcategory"),i=document.getElementById("cancel-new-subcategory"),r=document.getElementById("subcategory-icon-picker"),s=document.getElementById("subcategory-icon-dropdown");this.selectedSubcategoryIcon="tag",e?.addEventListener("click",()=>{t?.classList.remove("hidden"),e.classList.add("hidden"),n?.focus()}),i?.addEventListener("click",()=>{this.resetSubcategoryInput()}),a?.addEventListener("click",()=>{this.addNewSubcategory()}),n?.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),this.addNewSubcategory()):"Escape"===e.key&&this.resetSubcategoryInput()}),r?.addEventListener("click",()=>{s?.classList.toggle("hidden")}),s?.querySelectorAll(".icon-picker-option").forEach(e=>{e.addEventListener("click",()=>{s.querySelectorAll(".icon-picker-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),this.selectedSubcategoryIcon=e.dataset.icon;const t=e.querySelector("svg").cloneNode(!0);t.setAttribute("width","14"),t.setAttribute("height","14"),r.innerHTML="",r.appendChild(t)})}),document.addEventListener("click",e=>{r?.contains(e.target)||s?.contains(e.target)||s?.classList.add("hidden")})}resetSubcategoryInput(){const e=document.getElementById("new-subcategory-input"),t=document.getElementById("add-subcategory-btn"),n=document.getElementById("new-subcategory-name"),a=document.getElementById("subcategory-icon-dropdown"),i=document.getElementById("subcategory-icon-picker");e?.classList.add("hidden"),t?.classList.remove("hidden"),a?.classList.add("hidden"),n&&(n.value=""),this.selectedSubcategoryIcon="tag",a?.querySelectorAll(".icon-picker-option").forEach(e=>e.classList.remove("selected")),a?.querySelector('[data-icon="tag"]')?.classList.add("selected"),i&&(i.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>')}addNewSubcategory(){const e=document.getElementById("new-subcategory-name"),t=document.getElementById("subcategories-list"),n=e?.value?.trim();if(!n)return void this.showToast("Ingresa un nombre para la subcategor√≠a","warning");const a=this.generateSlug(n);if(document.querySelector(`input[name="subcategories"][value="${a}"]`))return void this.showToast("Esta subcategor√≠a ya existe","warning");const i=this.getSubcategoryIconSvg(this.selectedSubcategoryIcon||"tag"),r=document.createElement("label");r.className="category-option subcategory-item",r.innerHTML=`\n      <input type="checkbox" name="subcategories" value="${a}" checked>\n      <span class="category-badge">\n        ${i}\n        ${this.escapeHtml(n)}\n      </span>\n      <button type="button" class="category-delete-btn" title="Eliminar subcategor√≠a">\n        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>\n      </button>\n    `,r.querySelector(".category-delete-btn").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.deleteSubcategory(r,n)}),t?.appendChild(r),this.resetSubcategoryInput(),this.showToast(`Subcategor√≠a "${n}" agregada`,"success")}getSubcategoryIconSvg(e){const t={tag:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',star:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',heart:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',zap:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',music:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',book:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',globe:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',plus:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>'};return t[e]||t.tag}deleteSubcategory(e,t){e.remove(),this.showToast(`Subcategor√≠a "${t}" eliminada`,"success")}getSelectedSubcategories(){const e=document.querySelectorAll('input[name="subcategories"]:checked');return Array.from(e).map(e=>e.value)}getPrimaryCategory(){const e=document.querySelector('input[name="category"]:checked');return e?.value||"series"}getSelectedCategories(){const e=[this.getPrimaryCategory()];return this.tags&&this.tags.length>0&&e.push(...this.tags),e}}window.admin=new SalaGeekAdmin;